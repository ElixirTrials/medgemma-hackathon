---
phase: 05.1-error-handling-hardening
plan: 01
subsystem: api, agents, infra
tags: [error-handling, fail-fast, gcs, database, umls, mcp]

# Dependency graph
requires:
  - phase: 05-entity-grounding-workflow
    provides: MCP grounding, UMLS client, agent-b graph nodes
  - phase: 02-protocol-upload-storage
    provides: GCS upload/download, database storage layer
provides:
  - Fail-fast GCS operations requiring GCS_BUCKET_NAME and credentials
  - Fail-fast DATABASE_URL validation at import time
  - Exception-propagating UMLS API clients (MCP server and agent-b)
  - MCP-only grounding path with no silent direct client fallback
affects: [05.2-test-coverage, 06-end-to-end-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Fail-fast pattern: raise ValueError at config load time for missing env vars"
    - "Exception propagation: remove try/except returning empty defaults in API clients"
    - "No mock fallbacks: services require real dependencies or fail loudly"

key-files:
  created: []
  modified:
    - services/api-service/src/api_service/gcs.py
    - services/api-service/src/api_service/main.py
    - services/api-service/src/api_service/storage.py
    - libs/inference/src/inference/loaders.py
    - services/umls-mcp-server/src/umls_mcp_server/umls_api.py
    - services/agent-b-service/src/agent_b_service/umls_client.py
    - services/agent-b-service/src/agent_b_service/nodes/ground_to_umls.py

key-decisions:
  - "Kept local:// path rejection as ValueError in gcs.py (explicit error vs silent ignore)"
  - "Used type: ignore for MultiServerMCPClient async context manager due to library typing limitation"
  - "queue.py error return already present -- verified rather than duplicated"

patterns-established:
  - "Fail-fast env vars: raise ValueError with descriptive message at module load"
  - "No silent fallbacks: API clients propagate exceptions, callers handle"

# Metrics
duration: 16min
completed: 2026-02-11
---

# Phase 5.1 Plan 01: Error Handling Hardening Summary

**Removed all mock fallbacks and silent error swallowing across 7 files: GCS raises on missing config, DATABASE_URL has no SQLite default, UMLS clients propagate exceptions, MCP-only grounding with no direct client fallback**

## Performance

- **Duration:** 16 min
- **Started:** 2026-02-11T14:42:56Z
- **Completed:** 2026-02-11T14:59:32Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- GCS operations (upload, download, metadata) raise ValueError when GCS_BUCKET_NAME unset or client unavailable -- no more localhost mock URLs
- DATABASE_URL raises ValueError at import time when not set -- no more SQLite fallback
- Removed /mock-upload endpoint from API service
- UMLS API client methods in both umls_mcp_server and agent-b propagate httpx exceptions instead of returning empty values
- Deleted entire _ground_via_direct_client function (87 lines) from ground_to_umls.py
- Fixed 3 mypy errors with proper StdioConnection typing and await on get_tools()
- All ruff checks and mypy pass clean (52 source files, 0 errors)

## Task Commits

Each task was committed atomically:

1. **Task 1: Remove GCS and DATABASE_URL mock fallbacks** - `d8045fa` (fix)
2. **Task 2: Fix UMLS error propagation, remove MCP fallback, fix mypy errors** - `ae82695` (fix)

## Files Created/Modified
- `services/api-service/src/api_service/gcs.py` - GCS operations fail loudly when not configured
- `services/api-service/src/api_service/main.py` - Removed /mock-upload endpoint and unused Request import
- `services/api-service/src/api_service/storage.py` - DATABASE_URL required, no SQLite fallback
- `libs/inference/src/inference/loaders.py` - Removed mock suggestion comment, improved error message
- `services/umls-mcp-server/src/umls_mcp_server/umls_api.py` - Removed try/except blocks from search, get_concept, get_snomed_code
- `services/agent-b-service/src/agent_b_service/umls_client.py` - Removed try/except from validate_cui, get_snomed_code_for_cui (kept input guards)
- `services/agent-b-service/src/agent_b_service/nodes/ground_to_umls.py` - MCP-only grounding, removed 87-line fallback function, fixed mypy

## Decisions Made
- Kept `local://` path detection in gcs.py as explicit ValueError rejection rather than removing entirely -- ensures any data with old mock paths gets a clear error
- Used `type: ignore[arg-type, misc]` for MultiServerMCPClient async context manager -- library's `__aexit__` returns `None` instead of `Awaitable[Any]`, a known typing limitation in langchain-mcp-adapters
- queue.py error return was already correctly implemented at line 116 -- verified rather than modified

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required. Note that services now require proper environment variables (GCS_BUCKET_NAME, DATABASE_URL, UMLS_API_KEY) to start.

## Next Phase Readiness
- All services fail fast with clear error messages when dependencies are missing
- Ready for Phase 5.2 (Test Coverage) to add tests verifying these error paths
- No mock fallbacks remain to mask configuration issues in production

---
## Self-Check: PASSED

All 7 modified files verified on disk. Both task commits (d8045fa, ae82695) verified in git log.

---
*Phase: 05.1-error-handling-hardening*
*Completed: 2026-02-11*

---
phase: 07-production-hardening
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/hitl-ui/src/hooks/useProtocols.ts
  - apps/hitl-ui/src/screens/ProtocolList.tsx
  - apps/hitl-ui/src/screens/ProtocolDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Protocol list shows failure status badges (extraction_failed, grounding_failed, dead_letter) with distinct red/orange colors"
    - "Protocol detail page shows categorized error reason when clicking a failed protocol"
    - "Retry Extraction button appears on failed and dead-letter protocols"
    - "Clicking Retry Extraction calls POST /protocols/{id}/retry and refreshes the protocol list"
    - "Delayed/pending protocols show a processing warning when circuit breaker is open"
  artifacts:
    - path: "apps/hitl-ui/src/hooks/useProtocols.ts"
      provides: "useRetryProtocol mutation hook and updated Protocol status type"
      contains: "useRetryProtocol"
    - path: "apps/hitl-ui/src/screens/ProtocolList.tsx"
      provides: "Failure status badges with distinct colors"
      contains: "extraction_failed"
    - path: "apps/hitl-ui/src/screens/ProtocolDetail.tsx"
      provides: "Error reason display and retry button"
      contains: "Retry Extraction"
  key_links:
    - from: "apps/hitl-ui/src/hooks/useProtocols.ts"
      to: "POST /protocols/{id}/retry"
      via: "useRetryProtocol mutation calling retry endpoint"
      pattern: "retry"
    - from: "apps/hitl-ui/src/screens/ProtocolDetail.tsx"
      to: "apps/hitl-ui/src/hooks/useProtocols.ts"
      via: "useRetryProtocol hook usage"
      pattern: "useRetryProtocol"
---

<objective>
Update the frontend to display failure statuses with distinct visual indicators, show categorized error reasons, and provide a "Retry Extraction" button for failed protocols.

Purpose: Per CONTEXT.md decision, researchers need to see protocol failures with actionable error messages ("Failed: PDF text quality too low", "Failed: AI service unavailable") and have the ability to manually retry via a button in the UI.

Output: Updated Protocol status type, failure status badges, error reason display, retry button with mutation hook.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-production-hardening/07-01-SUMMARY.md
@apps/hitl-ui/src/hooks/useProtocols.ts
@apps/hitl-ui/src/screens/ProtocolList.tsx
@apps/hitl-ui/src/screens/ProtocolDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Protocol type, add retry hook, and update status badges</name>
  <files>
    apps/hitl-ui/src/hooks/useProtocols.ts
    apps/hitl-ui/src/screens/ProtocolList.tsx
  </files>
  <action>
  **1. Update `apps/hitl-ui/src/hooks/useProtocols.ts`:**

  a. Update the `Protocol` interface status type to include all new statuses:
  ```typescript
  status:
      | 'uploaded'
      | 'extracting'
      | 'extraction_failed'
      | 'grounding'
      | 'grounding_failed'
      | 'pending_review'
      | 'complete'
      | 'dead_letter'
      | 'archived';
  ```

  b. Add `error_reason` field to Protocol interface:
  ```typescript
  error_reason: string | null;
  ```

  c. Add `useRetryProtocol` mutation hook:
  ```typescript
  export function useRetryProtocol() {
      const queryClient = useQueryClient();

      return useMutation({
          mutationFn: (protocolId: string) =>
              fetchApi<{ status: string; protocol_id: string }>(
                  `/protocols/${protocolId}/retry`,
                  { method: 'POST' }
              ),
          onSuccess: () => {
              queryClient.invalidateQueries({ queryKey: ['protocols'] });
          },
      });
  }
  ```

  **2. Update `apps/hitl-ui/src/screens/ProtocolList.tsx`:**

  a. Update `STATUS_OPTIONS` to include new failure statuses:
  ```typescript
  const STATUS_OPTIONS = [
      'All',
      'uploaded',
      'extracting',
      'extraction_failed',
      'grounding',
      'grounding_failed',
      'pending_review',
      'complete',
      'dead_letter',
  ] as const;
  ```

  b. Update `STATUS_COLORS` to add distinct colors for failure states:
  ```typescript
  const STATUS_COLORS: Record<string, string> = {
      uploaded: 'bg-blue-100 text-blue-800',
      extracting: 'bg-yellow-100 text-yellow-800',
      extraction_failed: 'bg-red-100 text-red-800',
      grounding: 'bg-cyan-100 text-cyan-800',
      grounding_failed: 'bg-orange-100 text-orange-800',
      pending_review: 'bg-indigo-100 text-indigo-800',
      complete: 'bg-green-100 text-green-800',
      dead_letter: 'bg-red-200 text-red-900',
      archived: 'bg-gray-100 text-gray-500',
      // Keep legacy statuses for backward compat
      extracted: 'bg-green-100 text-green-800',
      reviewed: 'bg-purple-100 text-purple-800',
  };
  ```

  c. Update the `StatusBadge` component to show human-readable labels for status values with underscores. Add a label map:
  ```typescript
  const STATUS_LABELS: Record<string, string> = {
      uploaded: 'Uploaded',
      extracting: 'Extracting',
      extraction_failed: 'Extraction Failed',
      grounding: 'Grounding',
      grounding_failed: 'Grounding Failed',
      pending_review: 'Pending Review',
      complete: 'Complete',
      dead_letter: 'Dead Letter',
      archived: 'Archived',
      extracted: 'Extracted',
      reviewed: 'Reviewed',
  };

  function StatusBadge({ status }: { status: string }) {
      return (
          <span
              className={cn(
                  'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium',
                  STATUS_COLORS[status] ?? 'bg-gray-100 text-gray-800'
              )}
          >
              {STATUS_LABELS[status] ?? status}
          </span>
      );
  }
  ```

  d. In the filter chips, also use human-readable labels for the option display text:
  ```typescript
  {opt === 'All' ? 'All' : (STATUS_LABELS[opt] ?? opt)}
  ```
  </action>
  <verify>
  `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` passes (TypeScript type check).
  Visually confirm the ProtocolList page renders (if dev server is running).
  </verify>
  <done>
  Protocol interface has all 9 status values and error_reason field. useRetryProtocol mutation hook exists. Status badges show distinct colors for extraction_failed (red), grounding_failed (orange), dead_letter (dark red). Human-readable status labels replace underscore-separated values in UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error reason display and retry button to ProtocolDetail</name>
  <files>
    apps/hitl-ui/src/screens/ProtocolDetail.tsx
  </files>
  <action>
  Update `apps/hitl-ui/src/screens/ProtocolDetail.tsx` to show error information and retry button for failed protocols.

  **1. Import the retry hook:**
  ```typescript
  import { useProtocol, useRetryProtocol } from '../hooks/useProtocols';
  ```

  **2. Add an error alert section** that appears when `protocol.status` ends with `_failed` or is `dead_letter`:

  ```tsx
  {/* Error Information */}
  {(protocol.status === 'extraction_failed' ||
    protocol.status === 'grounding_failed' ||
    protocol.status === 'dead_letter') && (
      <div className="rounded-lg border border-red-200 bg-red-50 p-4 mb-6">
          <div className="flex items-start justify-between">
              <div>
                  <h3 className="text-sm font-semibold text-red-800">
                      {protocol.status === 'dead_letter'
                          ? 'Processing Failed (Retries Exhausted)'
                          : protocol.status === 'extraction_failed'
                            ? 'Extraction Failed'
                            : 'Grounding Failed'}
                  </h3>
                  <p className="mt-1 text-sm text-red-700">
                      {protocol.error_reason ?? 'An unknown error occurred during processing.'}
                  </p>
                  {protocol.status === 'dead_letter' && (
                      <p className="mt-1 text-xs text-red-600">
                          This protocol will be archived after 7 days.
                      </p>
                  )}
              </div>
              <RetryButton protocolId={protocol.id} />
          </div>
      </div>
  )}
  ```

  **3. Create a `RetryButton` component** within the same file (or inline):

  ```tsx
  function RetryButton({ protocolId }: { protocolId: string }) {
      const retryMutation = useRetryProtocol();

      return (
          <Button
              variant="outline"
              size="sm"
              onClick={(e) => {
                  e.stopPropagation();
                  retryMutation.mutate(protocolId);
              }}
              disabled={retryMutation.isPending}
              className="border-red-300 text-red-700 hover:bg-red-100"
          >
              {retryMutation.isPending ? (
                  <>
                      <Loader2 className="h-4 w-4 mr-1 animate-spin" />
                      Retrying...
                  </>
              ) : (
                  'Retry Extraction'
              )}
          </Button>
      );
  }
  ```

  Import `Loader2` from lucide-react if not already imported. Import `Button` from the UI components.

  **4. Add the `error_reason` field to the ProtocolResponse model** in the ProtocolDetail component if it uses a local interface (check -- it may already use the shared Protocol type from useProtocols.ts). If it has its own type, add `error_reason: string | null`.

  **5. Show a processing warning** for protocols in `uploaded` or `extracting` status that have been waiting longer than expected. Add a subtle info banner:
  ```tsx
  {(protocol.status === 'uploaded' || protocol.status === 'extracting') && (
      <div className="rounded-lg border border-blue-200 bg-blue-50 p-3 mb-6">
          <p className="text-sm text-blue-700">
              Processing in progress. This typically takes 2-5 minutes.
          </p>
      </div>
  )}
  ```

  **Note:** Per CONTEXT.md, when circuit breaker is open "user sees warning 'Processing delayed -- AI service temporarily unavailable'". This is handled server-side by the protocol status. If the protocol is stuck in "uploaded" for a long time, the user will see it hasn't progressed. The UI shows the processing banner above. If the protocol transitions to a failure status, the error alert from step 2 appears with the specific reason.
  </action>
  <verify>
  `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` passes.
  `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx biome check src/` passes (or only pre-existing warnings).
  </verify>
  <done>
  ProtocolDetail shows error alert with categorized error reason for failed/dead-letter protocols. "Retry Extraction" button appears on failed and dead-letter protocols. Clicking retry calls POST /protocols/{id}/retry and invalidates protocol queries. Dead-letter protocols show 7-day archival warning. Processing-in-progress banner shows for uploaded/extracting protocols.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/hitl-ui && npx tsc --noEmit` passes
2. `cd apps/hitl-ui && npx biome check src/` passes (or only pre-existing warnings)
3. Protocol status type includes all 9 values + error_reason
4. useRetryProtocol hook calls POST /protocols/{id}/retry
5. ProtocolList shows distinct color badges for all failure statuses
6. ProtocolDetail shows error reason alert for failed protocols
7. Retry Extraction button calls mutation and refreshes queries
</verification>

<success_criteria>
- Protocol interface has 9 status values and error_reason field
- Status badges have distinct colors: red for extraction_failed, orange for grounding_failed, dark red for dead_letter
- Human-readable labels shown instead of raw underscore values
- useRetryProtocol mutation hook calls POST /protocols/{id}/retry
- ProtocolDetail shows categorized error reason in error alert
- "Retry Extraction" button appears on extraction_failed, grounding_failed, dead_letter protocols
- Dead-letter protocols show 7-day archival warning
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-production-hardening/07-04-SUMMARY.md`
</output>

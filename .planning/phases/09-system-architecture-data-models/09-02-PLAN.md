---
phase: 09-system-architecture-data-models
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - docs/architecture/data-models.md
  - docs/architecture/index.md
  - mkdocs.yml
autonomous: true

must_haves:
  truths:
    - "Engineer can reference DB schema ER diagram showing Protocol, Criteria, CriteriaBatch, Entity, Review, AuditLog tables with relationships"
    - "Engineer can reference LangGraph state documentation showing ExtractionState and GroundingState TypedDict structures with field descriptions and data flow"
    - "data-models.md includes date_verified frontmatter metadata"
  artifacts:
    - path: "docs/architecture/data-models.md"
      provides: "Database schema ER diagram and LangGraph state documentation"
      contains: "erDiagram"
    - path: "docs/architecture/data-models.md"
      provides: "LangGraph ExtractionState and GroundingState documentation"
      contains: "ExtractionState"
  key_links:
    - from: "mkdocs.yml"
      to: "docs/architecture/data-models.md"
      via: "nav entry under Architecture section"
      pattern: "data-models"
    - from: "docs/architecture/index.md"
      to: "docs/architecture/data-models.md"
      via: "markdown link"
      pattern: "data-models"
---

<objective>
Create the data models documentation page with a Mermaid ER diagram for the database schema and class diagrams + tables for LangGraph state structures.

Purpose: Satisfies DATA-01 (database schema with ER diagram) and DATA-02 (LangGraph state documentation with field descriptions and data flow). Engineers can reference a single page for all data structures in the system.

Output: `docs/architecture/data-models.md` with ER diagram + LangGraph state docs, updated navigation in `mkdocs.yml`, updated architecture index page.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-system-architecture-data-models/09-RESEARCH.md
@.planning/phases/09-system-architecture-data-models/09-01-SUMMARY.md
@mkdocs.yml
@docs/architecture/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data-models.md with ER diagram and LangGraph state documentation</name>
  <files>docs/architecture/data-models.md</files>
  <action>
Create `docs/architecture/data-models.md` with the following structure:

**Frontmatter:**
```yaml
---
title: Data Models
date_verified: 2026-02-12
status: current
---
```

**Section 1: Data Models (heading)**

Brief intro explaining this page documents both the database schema (relational model) and the LangGraph agent state structures (TypedDict workflow state).

**Section 2: Database Schema**

**2a: Entity-Relationship Diagram**

Mermaid erDiagram with crow's foot notation showing ALL 7 tables from the domain model. Use the EXACT research Pattern 3 as the template. Tables and fields:

1. **Protocol**: id PK, title, file_uri, status (enum: uploaded/extracting/grounding/pending_review/complete), page_count, quality_score, error_reason, metadata_ (json), created_at, updated_at
2. **CriteriaBatch**: id PK, protocol_id FK, status (enum: pending_review/approved/rejected), extraction_model, created_at, updated_at
3. **Criteria**: id PK, batch_id FK, criteria_type (inclusion/exclusion), category, text, temporal_constraint (json), conditions (json), numeric_thresholds (json), assertion_status, confidence, source_section, review_status, created_at, updated_at
4. **Entity**: id PK, criteria_id FK, entity_type, text, span_start, span_end, umls_cui, snomed_code, preferred_term, grounding_confidence, grounding_method, review_status, context_window (json), created_at, updated_at
5. **Review**: id PK, reviewer_id FK, target_type, target_id FK, action, before_value (json), after_value (json), comment, created_at (only, immutable)
6. **AuditLog**: id PK, event_type, actor_id, target_type, target_id, details (json), created_at (only, immutable)
7. **OutboxEvent**: id PK, event_type, aggregate_type, aggregate_id, payload (json), idempotency_key UK, status (pending/published/failed), retry_count, published_at, created_at

Relationships with crow's foot notation:
- Protocol ||--o{ CriteriaBatch : "has many"
- CriteriaBatch ||--o{ Criteria : "contains"
- Criteria ||--o{ Entity : "has extracted"
- Protocol ||--o{ Review : "reviewed for"
- Criteria ||--o{ Review : "reviewed for"
- Entity ||--o{ Review : "reviewed for"

Note: OutboxEvent and AuditLog are standalone (no FK relationships to other tables).

**2b: Table Descriptions**

After the ER diagram, add a brief description for each table explaining its purpose:
- Protocol: Represents an uploaded clinical trial protocol PDF
- CriteriaBatch: Groups criteria extracted from a single extraction run
- Criteria: Individual inclusion/exclusion criterion extracted from a protocol
- Entity: Medical entity extracted from criteria text, grounded to UMLS/SNOMED
- Review: Records individual review actions (approve/reject/modify) by clinical researchers
- AuditLog: Immutable event log for all system actions (extraction, grounding, review)
- OutboxEvent: Transactional outbox for reliable async event delivery to agent services

Include a note: "All tables use UUID primary keys. Protocol, CriteriaBatch, Criteria, and Entity have created_at/updated_at timestamps. Review and AuditLog are immutable (created_at only)."

**Section 3: LangGraph State Schemas**

**3a: ExtractionState (Extraction Workflow)**

Mermaid classDiagram showing ExtractionState TypedDict with 7 fields (from research Pattern 4):
- protocol_id: str
- file_uri: str
- title: str
- markdown_content: str
- raw_criteria: list[dict]
- criteria_batch_id: str
- error: str | None

Include a note annotation: "State flow: 1. ingest node: populates markdown_content from PDF, 2. extract node: populates raw_criteria from Gemini, 3. parse node: validates and structures raw_criteria, 4. queue node: persists to DB, populates criteria_batch_id"

After the class diagram, include a field description table with columns: Field, Type, Populated By, Purpose. Use the EXACT field descriptions from research.

After the table, include an ASCII data flow diagram:
```
Trigger -> ingest (parses PDF) -> extract (calls Gemini) -> parse (validates) -> queue (persists) -> END
```

**3b: GroundingState (Grounding Workflow)**

Mermaid classDiagram showing GroundingState TypedDict with 8 fields:
- batch_id: str
- protocol_id: str
- criteria_ids: list[str]
- criteria_texts: list[dict]
- raw_entities: list[dict]
- grounded_entities: list[dict]
- entity_ids: list[str]
- error: str | None

Include a note annotation: "State flow: 1. extract_entities: populates raw_entities from MedGemma, 2. ground_to_umls: enriches with UMLS CUIs, 3. map_to_snomed: enriches with SNOMED codes, 4. validate_confidence: filters low-confidence, populates entity_ids"

After the class diagram, include a field description table with columns: Field, Type, Populated By, Purpose. Use the EXACT field descriptions from research.

After the table, include an ASCII data flow diagram:
```
Trigger -> extract_entities -> ground_to_umls -> map_to_snomed -> validate_confidence -> END
```

**3c: State Design Principles**

Brief section (3-5 bullet points) documenting the state design principles used:
- TypedDict over Pydantic for graph state (lighter weight, LangGraph native)
- Every state has an `error: str | None` field enabling conditional routing to END on failure
- Fields are populated progressively -- each node writes its output fields
- Trigger handlers initialize input fields (IDs, URIs); graph nodes populate derived fields
- State is scoped to a single workflow run (not shared across runs)

**Important formatting notes:**
- Wrap all Mermaid diagrams in triple-backtick mermaid fences
- Use Mermaid ER diagram crow's foot notation: `||--o{` for one-to-many, `||--||` for one-to-one
- In classDiagram, use `+` prefix for public fields and `list~dict~` syntax for generic types
- Keep field description tables immediately after their corresponding class diagrams
  </action>
  <verify>
1. `test -f docs/architecture/data-models.md && echo "EXISTS"` returns EXISTS
2. `grep -c "erDiagram" docs/architecture/data-models.md` returns 1
3. `grep -c "classDiagram" docs/architecture/data-models.md` returns 2 (ExtractionState + GroundingState)
4. `grep -c "Protocol\|CriteriaBatch\|Criteria\|Entity\|Review\|AuditLog\|OutboxEvent" docs/architecture/data-models.md` returns at least 7 (one per table)
5. `grep -c "ExtractionState\|GroundingState" docs/architecture/data-models.md` returns at least 2
6. `grep "date_verified" docs/architecture/data-models.md` returns match with 2026-02-12
7. `grep -c "Populated By" docs/architecture/data-models.md` returns at least 2 (one per state table)
8. `grep -c "||--o{" docs/architecture/data-models.md` returns at least 5 (one-to-many relationships)
  </verify>
  <done>
data-models.md exists with: (1) a Mermaid ER diagram showing all 7 database tables (Protocol, CriteriaBatch, Criteria, Entity, Review, AuditLog, OutboxEvent) with fields, data types, primary/foreign keys, and crow's foot cardinality notation, (2) ExtractionState classDiagram + field description table + data flow showing 4-node pipeline, (3) GroundingState classDiagram + field description table + data flow showing 4-node pipeline, (4) state design principles section, and (5) date_verified: 2026-02-12 in frontmatter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mkdocs.yml navigation and architecture index for data-models.md</name>
  <files>mkdocs.yml, docs/architecture/index.md</files>
  <action>
**Update mkdocs.yml:**

In the nav section, update the Architecture entry to add data-models.md. After Plan 09-01, it should look like:
```yaml
- Architecture:
    - Overview: architecture/index.md
    - System Architecture: architecture/system-architecture.md
```

Add the data-models entry:
```yaml
- Architecture:
    - Overview: architecture/index.md
    - System Architecture: architecture/system-architecture.md
    - Data Models: architecture/data-models.md
```

**Update docs/architecture/index.md:**

In the architecture index page (updated by Plan 09-01), remove the "(coming in Phase 9 Plan 02)" annotation from the Data Models link. The line should read:
```markdown
- **[Data Models](data-models.md)** -- Database schema (ER diagram) and LangGraph agent state documentation
```

If Plan 09-01 used different phrasing for the "coming soon" annotation, remove whatever placeholder text exists and replace with the clean link above.

**Verify the build:**

Run `uv run mkdocs build --strict` and confirm zero warnings. Both system-architecture.md and data-models.md should appear in the Architecture nav section.
  </action>
  <verify>
1. `grep "data-models" mkdocs.yml` returns a match under Architecture nav
2. `grep "data-models" docs/architecture/index.md` returns a match (link to sub-page)
3. `grep -v "coming" docs/architecture/index.md | grep "data-models"` returns a match (no "coming" annotation)
4. `uv run mkdocs build --strict 2>&1 | tail -5` exits 0 with no warnings
  </verify>
  <done>
mkdocs.yml nav includes data-models.md under Architecture section alongside system-architecture.md. architecture/index.md links to the data models page without placeholder annotations. `uv run mkdocs build --strict` passes with zero warnings.
  </done>
</task>

</tasks>

<verification>
1. `uv run mkdocs build --strict` exits 0 with zero warnings
2. docs/architecture/data-models.md contains ER diagram with all 7 tables
3. docs/architecture/data-models.md contains ExtractionState and GroundingState class diagrams
4. docs/architecture/data-models.md contains field description tables with "Populated By" column
5. docs/architecture/data-models.md has date_verified: 2026-02-12 in frontmatter
6. mkdocs.yml nav has data-models.md entry under Architecture
7. docs/architecture/index.md links to data-models.md without placeholder text
</verification>

<success_criteria>
- Engineer can navigate to Architecture > Data Models in the docs site
- ER diagram renders showing all 7 tables with relationships and field types
- ExtractionState and GroundingState diagrams render with field types
- Field description tables show Populated By and Purpose for each state field
- Data flow diagrams show node-by-node state evolution
- All diagrams include date_verified frontmatter
- MkDocs builds clean in strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-system-architecture-data-models/09-02-SUMMARY.md`
</output>

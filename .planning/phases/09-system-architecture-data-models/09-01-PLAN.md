---
phase: 09-system-architecture-data-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/architecture/system-architecture.md
  - docs/architecture/index.md
  - mkdocs.yml
autonomous: true

must_haves:
  truths:
    - "Engineer can view C4 Container diagram showing React UI, FastAPI, PostgreSQL, LangGraph agents, and FastMCP interactions"
    - "Engineer can reference wiring diagram explaining REST for frontend-backend and transactional outbox for event-driven agent triggers"
    - "system-architecture.md includes date_verified frontmatter metadata"
  artifacts:
    - path: "docs/architecture/system-architecture.md"
      provides: "C4 Container diagram and wiring diagram documentation"
      contains: "C4Container"
    - path: "docs/architecture/index.md"
      provides: "Architecture section overview with links to sub-pages"
      contains: "system-architecture"
  key_links:
    - from: "mkdocs.yml"
      to: "docs/architecture/system-architecture.md"
      via: "nav entry under Architecture section"
      pattern: "system-architecture"
    - from: "docs/architecture/index.md"
      to: "docs/architecture/system-architecture.md"
      via: "markdown link"
      pattern: "system-architecture"
---

<objective>
Create the system architecture documentation page with a Mermaid C4 Container diagram showing all system containers and a wiring diagram section explaining service communication patterns.

Purpose: Satisfies ARCH-01 (C4 Container diagram) and ARCH-02 (wiring diagram section). Engineers can reference a single page to understand the system's high-level structure, technology stack choices, and how services communicate.

Output: `docs/architecture/system-architecture.md` with C4 diagram + wiring section, updated navigation in `mkdocs.yml`, updated architecture index page.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-system-architecture-data-models/09-RESEARCH.md
@.planning/phases/08-documentation-foundation/08-02-SUMMARY.md
@mkdocs.yml
@docs/architecture/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create system-architecture.md with C4 Container diagram and wiring section</name>
  <files>docs/architecture/system-architecture.md</files>
  <action>
Create `docs/architecture/system-architecture.md` with the following structure:

**Frontmatter:**
```yaml
---
title: System Architecture
date_verified: 2026-02-12
status: current
---
```

**Section 1: System Architecture (heading)**

Brief introduction paragraph explaining this is the C4 Container (Level 2) view of the Clinical Trial Criteria Extraction System.

**Section 2: Container Diagram**

Mermaid C4Container diagram showing:
- Person: Clinical Researcher
- System_Boundary containing:
  - Container: HITL Review UI (React, TypeScript, Vite) -- web interface for protocol upload and criteria review
  - Container: API Service (FastAPI, Python) -- REST API orchestrating workflows and serving frontend
  - Container: Extraction Service (LangGraph, Python) -- agent extracting criteria from PDFs via Gemini
  - Container: Grounding Service (LangGraph, Python) -- agent grounding entities to UMLS/SNOMED via MCP
  - ContainerDb: Database (PostgreSQL) -- stores protocols, criteria, entities, audit logs
- External containers:
  - Container_Ext: GCS Bucket (Google Cloud Storage) -- PDF storage
  - Container_Ext: Gemini API (Google AI) -- criteria extraction LLM
  - Container_Ext: MedGemma (Vertex AI) -- medical entity extraction
  - Container_Ext: UMLS MCP Server (FastMCP, Python) -- UMLS concept search and linking
  - Container_Ext: UMLS REST API (NIH NLM) -- UMLS concept validation
- Relationships (Rel):
  - Researcher -> UI: "Uses" (HTTPS)
  - UI -> API: "API calls" (REST/JSON)
  - API -> DB: "Reads/writes" (SQLAlchemy)
  - API -> Extraction Service: "Triggers via outbox events" (Transactional outbox)
  - API -> Grounding Service: "Triggers via outbox events" (Transactional outbox)
  - API -> GCS: "Signed URLs" (GCS client)
  - Extraction Service -> Gemini: "LLM calls" (Google AI SDK)
  - Grounding Service -> MedGemma: "Entity extraction" (Vertex AI SDK)
  - Grounding Service -> UMLS MCP: "Tool calls" (MCP protocol)
  - UMLS MCP -> UMLS API: "Validates concepts" (REST/JSON)

Use the EXACT Mermaid C4 syntax from the research examples (Pattern 1). Every Container must have 4 parameters: alias, label, tech, description.

**Section 3: Service Communication Patterns**

Document three communication patterns with subsections:

**3a: Frontend <-> Backend: REST over HTTPS**
- Synchronous request/response via JSON payloads
- All endpoints documented in OpenAPI spec (/docs)
- Authentication via Google OAuth session cookies + JWT
- Pagination for large result sets
- Error responses follow standard HTTP status codes

**3b: Backend <-> Agents: Transactional Outbox Pattern**
- Explain the transactional outbox pattern flow (5 steps from research Pattern 2):
  1. API commits DB transaction (e.g., create Protocol)
  2. Same transaction inserts OutboxEvent with event type
  3. OutboxProcessor polls pending events (every 5s)
  4. Processor invokes agent trigger handler
  5. On success, mark published; on failure, increment retry_count with exponential backoff
- Benefits: no dual-write problem, guaranteed delivery, idempotency
- Event types list:
  - ProtocolUploaded -> triggers extraction-service
  - CriteriaExtracted -> triggers grounding-service
  - EntitiesGrounded -> updates protocol status to pending_review
  - ReviewCompleted -> triggers downstream analytics (future)

**3c: Agents <-> External Services: SDK Calls**
- Gemini API via google.generativeai SDK
- MedGemma via vertexai SDK
- UMLS MCP Server via mcp client protocol
- UMLS REST API via httpx (through MCP server)
- All external calls: 30s timeout, exponential backoff retry (tenacity, max 3 retries)

**Important formatting notes:**
- Use proper Markdown headings (##, ###) for sections
- Wrap Mermaid diagrams in triple-backtick mermaid fences
- Keep wiring section focused on architectural patterns, not implementation details
- Note "This shows happy path; see Production Hardening for error handling" where relevant
  </action>
  <verify>
1. `test -f docs/architecture/system-architecture.md && echo "EXISTS"` returns EXISTS
2. `grep -c "C4Container" docs/architecture/system-architecture.md` returns 1
3. `grep -c "Container(" docs/architecture/system-architecture.md` returns at least 4 (internal containers)
4. `grep -c "Container_Ext(" docs/architecture/system-architecture.md` returns at least 4 (external services)
5. `grep -c "Transactional Outbox" docs/architecture/system-architecture.md` returns at least 1
6. `grep "date_verified" docs/architecture/system-architecture.md` returns a match with 2026-02-12
7. `grep -c "ProtocolUploaded\|CriteriaExtracted\|EntitiesGrounded\|ReviewCompleted" docs/architecture/system-architecture.md` returns at least 4
  </verify>
  <done>
system-architecture.md exists with: (1) a Mermaid C4 Container diagram showing all 5 internal containers (UI, API, Extraction, Grounding, DB) + 5 external containers (GCS, Gemini, MedGemma, UMLS MCP, UMLS API) with technology labels and relationships, (2) a wiring section documenting REST, transactional outbox, and SDK communication patterns with event types listed, and (3) date_verified: 2026-02-12 in frontmatter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mkdocs.yml navigation and architecture index page</name>
  <files>mkdocs.yml, docs/architecture/index.md</files>
  <action>
**Update mkdocs.yml:**

In the nav section, update the Architecture entry from:
```yaml
- Architecture:
    - Overview: architecture/index.md
```
to:
```yaml
- Architecture:
    - Overview: architecture/index.md
    - System Architecture: architecture/system-architecture.md
```

Do NOT add data-models.md yet -- that will be added in Plan 09-02.

**Update docs/architecture/index.md:**

Replace the placeholder content with a real overview page:

```markdown
# Architecture

This section documents the system architecture of the Clinical Trial Criteria Extraction System.

## Documentation

- **[System Architecture](system-architecture.md)** -- C4 Container diagram showing system structure, technology stack, and service communication patterns (REST, transactional outbox, SDK calls)
- **[Data Models](data-models.md)** -- Database schema (ER diagram) and LangGraph agent state documentation *(coming in Phase 9 Plan 02)*

## Key Architectural Decisions

| Decision | Rationale |
|----------|-----------|
| Microservices (api, extraction, grounding) | Natural mapping to pipeline stages; independent scaling |
| LangGraph for agent workflows | TypedDict state management, conditional routing, node-based processing |
| Transactional outbox for events | Atomic DB + event writes, guaranteed delivery, no dual-write problem |
| FastMCP for UMLS integration | Tool-based interface for concept search/linking, protocol-standard |
| PostgreSQL with SQLModel ORM | Pydantic integration, type-safe queries, Alembic migrations |
| React + Vite for HITL UI | Fast dev builds, TanStack Query for server state, Zustand for client state |
```

Note: Reference data-models.md with "(coming in Phase 9 Plan 02)" annotation since it doesn't exist yet but will exist after Plan 02 runs.

**Verify the build:**

Run `uv run mkdocs build --strict` and confirm zero warnings. The system-architecture.md page should build correctly and appear in the Architecture nav section.
  </action>
  <verify>
1. `grep "system-architecture" mkdocs.yml` returns a match under Architecture nav
2. `grep "system-architecture" docs/architecture/index.md` returns a match (link to sub-page)
3. `uv run mkdocs build --strict 2>&1 | tail -5` exits 0 with no warnings
  </verify>
  <done>
mkdocs.yml nav includes system-architecture.md under Architecture section. architecture/index.md links to the system architecture page. `uv run mkdocs build --strict` passes with zero warnings.
  </done>
</task>

</tasks>

<verification>
1. `uv run mkdocs build --strict` exits 0 with zero warnings
2. docs/architecture/system-architecture.md contains C4Container diagram with all containers
3. docs/architecture/system-architecture.md contains wiring diagram section with 3 communication patterns
4. docs/architecture/system-architecture.md has date_verified: 2026-02-12 in frontmatter
5. mkdocs.yml nav has system-architecture.md entry under Architecture
6. docs/architecture/index.md links to system-architecture.md
</verification>

<success_criteria>
- Engineer can navigate to Architecture > System Architecture in the docs site
- C4 Container diagram renders showing all system containers with technology labels
- Wiring section explains REST, transactional outbox, and SDK communication patterns
- All diagrams include date_verified frontmatter
- MkDocs builds clean in strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-system-architecture-data-models/09-01-SUMMARY.md`
</output>

---
phase: 23-core-structured-editor-component
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/hitl-ui/src/components/structured-editor/types.ts
  - apps/hitl-ui/src/components/structured-editor/constants.ts
  - apps/hitl-ui/src/components/structured-editor/RelationSelect.tsx
  - apps/hitl-ui/src/components/structured-editor/ValueInput.tsx
  - apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx
autonomous: true

must_haves:
  truths:
    - "StructuredFieldEditor renders entity/relation/value triplet fields for a criterion"
    - "Relation dropdown offers all 10 operators: =, !=, >, >=, <, <=, within, not_in_last, contains, not_contains"
    - "Selecting a standard operator (=, !=, >, >=, <, <=, contains, not_contains) shows a single value input"
    - "Selecting 'within' or range-category relation shows min/max value inputs"
    - "Selecting 'not_in_last' or temporal-category relation shows duration number + unit dropdown"
    - "Changing relation type clears stale value fields (no state leak between relation categories)"
    - "Form state is managed via react-hook-form with useFieldArray for threshold arrays"
  artifacts:
    - path: "apps/hitl-ui/src/components/structured-editor/types.ts"
      provides: "TypeScript discriminated union types for relation categories and form values"
      contains: "RelationCategory"
    - path: "apps/hitl-ui/src/components/structured-editor/constants.ts"
      provides: "RELATIONS array with all 10 operators, category mapping, temporal unit options"
      contains: "RELATIONS"
    - path: "apps/hitl-ui/src/components/structured-editor/RelationSelect.tsx"
      provides: "Radix UI Select wrapper for relation/operator dropdown"
      contains: "RelationSelect"
    - path: "apps/hitl-ui/src/components/structured-editor/ValueInput.tsx"
      provides: "Adaptive value input that switches between standard/range/temporal based on relation category"
      contains: "ValueInput"
    - path: "apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx"
      provides: "Main editor component with react-hook-form, entity field, relation select, and value input"
      exports: ["StructuredFieldEditor"]
  key_links:
    - from: "apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx"
      to: "apps/hitl-ui/src/components/structured-editor/RelationSelect.tsx"
      via: "import and render as controlled component"
      pattern: "import.*RelationSelect"
    - from: "apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx"
      to: "apps/hitl-ui/src/components/structured-editor/ValueInput.tsx"
      via: "import and render with relation-dependent switching"
      pattern: "import.*ValueInput"
    - from: "apps/hitl-ui/src/components/structured-editor/ValueInput.tsx"
      to: "apps/hitl-ui/src/components/structured-editor/constants.ts"
      via: "import RELATION_CATEGORY_MAP to determine which sub-input to render"
      pattern: "import.*RELATION_CATEGORY_MAP"
    - from: "apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx"
      to: "react-hook-form"
      via: "useForm + useFieldArray for form state management"
      pattern: "useForm|useFieldArray"
---

<objective>
Build the StructuredFieldEditor component with entity/relation/value triplet fields, Radix UI relation dropdown with all 10 operators, and adaptive value input that changes based on relation type.

Purpose: This is the core UI component for v1.5 structured criteria editing. It must be testable in isolation (no CriterionCard integration yet -- that is Phase 24). The component renders a triplet editor where reviewers specify entity text, select a relation operator, and enter a value that adapts to the operator type.

Output: 5 new files in `apps/hitl-ui/src/components/structured-editor/` providing a fully functional, form-validated structured field editor component.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/hitl-ui/src/components/CriterionCard.tsx
@apps/hitl-ui/src/components/EntityCard.tsx
@apps/hitl-ui/src/components/ui/Button.tsx
@apps/hitl-ui/src/hooks/useReviews.ts
@apps/hitl-ui/src/lib/utils.ts
@apps/hitl-ui/package.json
@apps/hitl-ui/biome.json
@apps/hitl-ui/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types, constants, and Radix Select wrapper for relation operators</name>
  <files>
    apps/hitl-ui/src/components/structured-editor/types.ts
    apps/hitl-ui/src/components/structured-editor/constants.ts
    apps/hitl-ui/src/components/structured-editor/RelationSelect.tsx
  </files>
  <action>
Create the `structured-editor` directory under `apps/hitl-ui/src/components/`.

**types.ts** -- Define TypeScript types for the structured editor form:

1. `RelationOperator` -- literal union of all 10 operators: `'=' | '!=' | '>' | '>=' | '<' | '<=' | 'within' | 'not_in_last' | 'contains' | 'not_contains'`

2. `RelationCategory` -- discriminated union tag: `'standard' | 'range' | 'temporal'`. This categorizes which value input to show.
   - `standard`: =, !=, >, >=, <, <=, contains, not_contains (single value input)
   - `range`: within (min + max value inputs)
   - `temporal`: not_in_last (duration number + unit dropdown)

3. `TemporalUnit` -- literal union: `'days' | 'weeks' | 'months' | 'years'`

4. `StandardValue` -- `{ type: 'standard'; value: string; unit: string }`

5. `RangeValue` -- `{ type: 'range'; min: string; max: string; unit: string }`

6. `TemporalValue` -- `{ type: 'temporal'; duration: string; unit: TemporalUnit }`

7. `FieldValue` -- discriminated union: `StandardValue | RangeValue | TemporalValue`

8. `StructuredFieldFormValues` -- the react-hook-form shape:
   ```ts
   {
     entity: string;          // free text entity name (UMLS autocomplete added in Phase 25)
     relation: RelationOperator | '';
     value: FieldValue;
   }
   ```

9. `StructuredFieldEditorProps` -- component props:
   ```ts
   {
     criterionId: string;
     initialValues?: Partial<StructuredFieldFormValues>;
     onSave: (values: StructuredFieldFormValues) => void;
     onCancel: () => void;
     isSubmitting?: boolean;
   }
   ```

**constants.ts** -- Define relation configuration:

1. `RELATIONS` -- array of `{ operator: RelationOperator; label: string; category: RelationCategory }`:
   - `{ operator: '=', label: 'equals (=)', category: 'standard' }`
   - `{ operator: '!=', label: 'not equals (!=)', category: 'standard' }`
   - `{ operator: '>', label: 'greater than (>)', category: 'standard' }`
   - `{ operator: '>=', label: 'greater or equal (>=)', category: 'standard' }`
   - `{ operator: '<', label: 'less than (<)', category: 'standard' }`
   - `{ operator: '<=', label: 'less or equal (<=)', category: 'standard' }`
   - `{ operator: 'within', label: 'within (range)', category: 'range' }`
   - `{ operator: 'not_in_last', label: 'not in last (temporal)', category: 'temporal' }`
   - `{ operator: 'contains', label: 'contains', category: 'standard' }`
   - `{ operator: 'not_contains', label: 'does not contain', category: 'standard' }`

2. `RELATION_CATEGORY_MAP` -- `Record<RelationOperator, RelationCategory>` derived from RELATIONS array for O(1) lookup.

3. `TEMPORAL_UNITS` -- array of `{ value: TemporalUnit; label: string }`:
   - `{ value: 'days', label: 'Days' }`
   - `{ value: 'weeks', label: 'Weeks' }`
   - `{ value: 'months', label: 'Months' }`
   - `{ value: 'years', label: 'Years' }`

4. `DEFAULT_FIELD_VALUES` -- default form values:
   ```ts
   { entity: '', relation: '' as const, value: { type: 'standard', value: '', unit: '' } }
   ```

5. Helper function `getDefaultValueForCategory(category: RelationCategory): FieldValue` that returns the correct empty value shape for each category.

**RelationSelect.tsx** -- Radix UI Select wrapper:

1. Import from `@radix-ui/react-select` (already in package.json at v2.1.6).

2. Props: `{ value: RelationOperator | ''; onChange: (value: RelationOperator) => void; disabled?: boolean }`

3. Render a Radix Select.Root with Select.Trigger showing the current operator label (or "Select relation..." placeholder). Use the `cn()` utility from `../../lib/utils` for className merging.

4. Select.Content with Select.Group containing Select.Item for each entry in RELATIONS. Group items visually by category using Select.Label separators: "Comparison", "Range", "Temporal", "Text Match". Map categories to groups:
   - "Comparison": =, !=, >, >=, <, <=
   - "Range": within
   - "Temporal": not_in_last
   - "Text Match": contains, not_contains

5. Style the trigger to match existing form inputs in CriterionCard.tsx: `w-full rounded-md border border-input bg-background px-3 py-2 text-sm`. Style the content with `bg-popover rounded-md border shadow-md`.

6. Use ChevronDown icon from lucide-react on the trigger (consistent with existing icon usage in EntityCard.tsx).

Do NOT use native HTML select elements -- the research explicitly chose Radix UI Select.
  </action>
  <verify>
Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` to verify all TypeScript types compile without errors. Verify the 3 files exist and contain the expected exports.
  </verify>
  <done>
types.ts exports RelationOperator, RelationCategory, TemporalUnit, FieldValue, StructuredFieldFormValues, StructuredFieldEditorProps. constants.ts exports RELATIONS (10 entries), RELATION_CATEGORY_MAP, TEMPORAL_UNITS, DEFAULT_FIELD_VALUES, getDefaultValueForCategory. RelationSelect.tsx exports a Radix UI Select component rendering all 10 operators grouped by category. All files compile with strict TypeScript.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build StructuredFieldEditor with adaptive value input and form state management</name>
  <files>
    apps/hitl-ui/src/components/structured-editor/ValueInput.tsx
    apps/hitl-ui/src/components/structured-editor/StructuredFieldEditor.tsx
  </files>
  <action>
**ValueInput.tsx** -- Adaptive value input component that renders different fields based on relation category:

1. Props: `{ category: RelationCategory; value: FieldValue; onChange: (value: FieldValue) => void; disabled?: boolean }`

2. Three internal sub-components (NOT separate files -- keep them co-located in this file for simplicity):

   **StandardValueInput**: Renders when `category === 'standard'`.
   - Single text input for value (label: "Value")
   - Single text input for unit (label: "Unit", placeholder: "e.g., years, mg/dL")
   - Both in a `grid grid-cols-2 gap-3` layout matching CriterionCard.tsx edit grid pattern.
   - onChange calls parent with `{ type: 'standard', value, unit }`.

   **RangeValueInput**: Renders when `category === 'range'`.
   - Three inputs in a row: min value, max value, unit.
   - `grid grid-cols-3 gap-3` layout.
   - Labels: "Min", "Max", "Unit".
   - onChange calls parent with `{ type: 'range', min, max, unit }`.

   **TemporalValueInput**: Renders when `category === 'temporal'`.
   - Number input for duration (label: "Duration")
   - Radix Select for unit with TEMPORAL_UNITS options (label: "Unit")
   - `grid grid-cols-2 gap-3` layout.
   - onChange calls parent with `{ type: 'temporal', duration, unit }`.
   - Use a second Radix Select (same styling pattern as RelationSelect) for the temporal unit dropdown.

3. The main ValueInput component switches on `category` and renders the appropriate sub-component. If no category is determined (relation not yet selected), render nothing.

4. All inputs use the same Tailwind input styling as CriterionCard.tsx: `w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring`

5. Each input has a `<label>` with `block text-sm font-medium text-muted-foreground mb-1` matching CriterionCard edit labels.

**StructuredFieldEditor.tsx** -- Main editor component:

1. Import `useForm` from `react-hook-form` (v7.55.0 already in package.json). Do NOT import useFieldArray yet -- that is for Phase 27 multi-mapping. For now, single mapping uses simple `useForm`.

2. Accept `StructuredFieldEditorProps` as props.

3. Initialize form with `useForm<StructuredFieldFormValues>({ defaultValues: initialValues ?? DEFAULT_FIELD_VALUES })`.

4. **Critical: State cleanup on relation change.** Use `watch('relation')` + `useEffect` to detect when the relation operator changes. When it changes:
   - Look up the new relation's category via `RELATION_CATEGORY_MAP`.
   - Compare to the current value's type.
   - If the category changed (e.g., standard -> temporal), call `setValue('value', getDefaultValueForCategory(newCategory))` to reset the value fields. This prevents state leak (e.g., leftover min/max values when switching from range to standard).
   - Store the previous relation in a ref to detect actual changes (not initial render).

5. Layout (vertical stack with `space-y-4`):
   a. **Entity field**: Label "Entity" + text input. Register with `register('entity')`. Placeholder: "e.g., Age, HbA1c, Acetaminophen". This is plain text for now (UMLS autocomplete in Phase 25).
   b. **Relation field**: Label "Relation" + RelationSelect component. Use `Controller` from react-hook-form to wire the Radix Select (since Radix uses its own onChange, not a native input ref).
   c. **Value field**: Conditionally rendered ValueInput. Only show when a relation is selected. Pass the current relation's category. Use `Controller` for the FieldValue object.

6. **Action buttons** (matching CriterionCard pattern):
   - "Save" button (primary, uses Button component from ui/Button.tsx) -- calls `handleSubmit(onSave)`.
   - "Cancel" button (outline variant) -- calls `onCancel`.
   - Disable both when `isSubmitting` is true.
   - Show `Loader2` spinner on Save when submitting (same pattern as CriterionCard.tsx).

7. Wrap the entire form in a `<div>` (not `<form>` -- it will be embedded inside the CriterionCard in Phase 24 and we want to avoid nested forms). Use `handleSubmit` on the Save button's onClick instead.

8. Export `StructuredFieldEditor` as the default export AND as a named export (for flexible importing).

**Important anti-patterns to avoid (from research):**
- Do NOT use separate `useState` for each field -- use react-hook-form exclusively for form state.
- Do NOT use `any` types -- use the discriminated union types from types.ts.
- Do NOT add modal/drawer wrappers -- this component renders inline.
  </action>
  <verify>
Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` to verify TypeScript compilation. Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx biome check src/components/structured-editor/` to verify lint passes. Verify all 5 files in the structured-editor directory exist. Check that StructuredFieldEditor imports and uses RelationSelect, ValueInput, types, and constants without circular dependencies.
  </verify>
  <done>
StructuredFieldEditor.tsx renders entity text input, RelationSelect dropdown with all 10 operators, and adaptive ValueInput that switches between standard (single value + unit), range (min + max + unit), and temporal (duration + unit dropdown) based on selected relation. Changing relation type resets value fields to prevent state leak. Form state managed entirely via react-hook-form useForm. Save/Cancel buttons match existing CriterionCard pattern. All files pass TypeScript strict mode and biome linting.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` -- zero TypeScript errors
2. `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx biome check src/components/structured-editor/` -- zero lint errors
3. `ls apps/hitl-ui/src/components/structured-editor/` shows 5 files: types.ts, constants.ts, RelationSelect.tsx, ValueInput.tsx, StructuredFieldEditor.tsx
4. `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npm run build` -- Vite build completes (no import errors, no tree-shaking issues)
</verification>

<success_criteria>
- EDIT-02: StructuredFieldEditor renders entity/relation/value triplet fields -- entity text input, relation Radix Select, and value inputs visible
- EDIT-03: RelationSelect contains all 10 operators (=, !=, >, >=, <, <=, within, not_in_last, contains, not_contains) in grouped categories
- EDIT-04: ValueInput renders standard (single value) for comparison/text operators, range (min/max) for within, temporal (duration+unit) for not_in_last
- State cleanup: switching relation category resets value fields via useEffect + setValue
- No state leak: no leftover min/max when switching from range to standard, no leftover duration when switching from temporal to standard
- All TypeScript strict, all biome lint passing
</success_criteria>

<output>
After completion, create `.planning/phases/23-core-structured-editor-component/23-01-SUMMARY.md`
</output>

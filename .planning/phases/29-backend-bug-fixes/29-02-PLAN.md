---
phase: 29-backend-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/api-service/src/api_service/reviews.py
  - apps/hitl-ui/src/hooks/useReviews.ts
  - apps/hitl-ui/src/components/CriterionAuditHistory.tsx
  - apps/hitl-ui/src/components/CriterionCard.tsx
  - apps/hitl-ui/src/screens/ReviewPage.tsx
  - apps/hitl-ui/src/screens/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Audit trail entries are visible on the Review page after approve/reject/modify actions, scoped to the current batch"
    - "Each criterion card shows its own audit history in a collapsible 'History' section (collapsed by default)"
    - "Dashboard pending count includes batches with any unreviewed criteria, showing both batch count and criteria count (e.g., '3 batches (47 criteria)')"
    - "Batches with partially reviewed criteria (e.g., 1/41 done) are counted as pending, not hidden"
  artifacts:
    - path: "services/api-service/src/api_service/reviews.py"
      provides: "Audit log batch_id filter and criteria-level pending count query"
      contains: "batch_id"
    - path: "apps/hitl-ui/src/components/CriterionAuditHistory.tsx"
      provides: "Collapsible per-criterion audit history component"
      contains: "CriterionAuditHistory"
    - path: "apps/hitl-ui/src/hooks/useReviews.ts"
      provides: "Updated useAuditLog hook accepting batchId parameter"
      contains: "batchId"
    - path: "apps/hitl-ui/src/screens/Dashboard.tsx"
      provides: "Dashboard with criteria-level pending count display"
      contains: "pending_criteria"
  key_links:
    - from: "apps/hitl-ui/src/components/CriterionAuditHistory.tsx"
      to: "apps/hitl-ui/src/hooks/useReviews.ts"
      via: "useAuditLog hook with criterionId parameter"
      pattern: "useAuditLog.*criterionId"
    - from: "apps/hitl-ui/src/hooks/useReviews.ts"
      to: "services/api-service/src/api_service/reviews.py"
      via: "GET /reviews/audit-log?batch_id= API call"
      pattern: "batch_id"
    - from: "apps/hitl-ui/src/screens/Dashboard.tsx"
      to: "services/api-service/src/api_service/reviews.py"
      via: "Pending count API response with criteria-level counts"
      pattern: "pending_criteria"
---

<objective>
Fix audit trail invisibility (BUGF-02) and dashboard pending count semantic confusion (BUGF-03). Add batch_id filter to audit log API, create inline per-criterion audit history UI component, and fix pending count to use criteria-level query instead of batch status.

Purpose: Audit trail visibility is required for 21 CFR Part 11 regulatory compliance. Pending count accuracy ensures reviewers don't miss batches with unreviewed criteria.

Output: Visible per-criterion audit history on Review page, accurate pending count on Dashboard showing both batch and criteria counts.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-backend-bug-fixes/29-RESEARCH.md
@services/api-service/src/api_service/reviews.py
@apps/hitl-ui/src/hooks/useReviews.ts
@apps/hitl-ui/src/components/CriterionCard.tsx
@apps/hitl-ui/src/screens/ReviewPage.tsx
@apps/hitl-ui/src/screens/Dashboard.tsx
@libs/shared/src/shared/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend fixes — audit log batch_id filter and criteria-level pending count</name>
  <files>services/api-service/src/api_service/reviews.py</files>
  <action>
**BUGF-02 Backend: Add batch_id filter to audit log endpoint.**

In the `list_audit_log` function (around line 396-448 in reviews.py):
1. Add `batch_id: str | None = Query(default=None)` parameter to the endpoint
2. When batch_id is provided, join AuditLog to Criteria table on `AuditLog.target_id == Criteria.id` and filter by `Criteria.batch_id == batch_id` AND `AuditLog.target_type == "criteria"`
3. Apply the same join logic to BOTH the count query and the data query (both need the batch_id filter for correct pagination)
4. When batch_id is NOT provided, keep existing filter behavior unchanged (backward compatible)

Follow the exact pattern from 29-RESEARCH.md "Pattern 1: Backend API Filter Fix".

**BUGF-03 Backend: Add criteria-level pending count query.**

In the batch list endpoint or a new summary helper:
1. Add a `get_pending_counts(db)` helper function that queries:
   - `pending_criteria`: COUNT of Criteria where `review_status IS NULL` joined with CriteriaBatch where `status IN ('pending_review', 'in_progress')`
   - `pending_batches`: COUNT DISTINCT of CriteriaBatch.id from same join (batches with ANY unreviewed criteria)
2. Add these counts to the batch list API response OR add a `GET /reviews/pending-summary` endpoint that returns `{ pending_batches, pending_criteria, message }` where message is formatted as "N batches (M criteria) pending review"
3. Update the existing batch list response to include `pending_criteria_count` and `pending_batches_count` fields

Follow the exact pattern from 29-RESEARCH.md "Pattern 2: Criteria-Level Aggregation Query".

**BUGF-03 Backend: Auto-update batch status when all criteria reviewed.**

Per user decision: "When all criteria in a batch are reviewed, batch status auto-updates to 'reviewed'":
1. In `_update_batch_status()` (around line 509-546), after the existing approved/rejected transitions, add a check: if all criteria have a non-null review_status (all reviewed) but the batch is still in_progress, transition to 'reviewed' status
2. Keep existing 'approved' (all approved) and 'rejected' (any rejected) as terminal states
3. 'reviewed' is a new intermediate state meaning "all criteria reviewed, mixed or no explicit approval"

Run `uv run ruff check services/api-service/` and `uv run pytest services/api-service/tests/` to verify.
  </action>
  <verify>
`uv run ruff check services/api-service/` passes clean.
`uv run pytest services/api-service/tests/` passes all tests.
`uv run mypy services/api-service/src/` passes or shows only pre-existing errors.
Verify the endpoint accepts batch_id parameter by checking the function signature.
  </verify>
  <done>
Audit log endpoint accepts batch_id query parameter and returns scoped results via Criteria join. Pending count query uses criteria-level review_status (not batch status) to count unreviewed work. Batch status auto-transitions to 'reviewed' when all criteria are reviewed. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend fixes — audit history UI, hook updates, and pending count display</name>
  <files>
    apps/hitl-ui/src/hooks/useReviews.ts
    apps/hitl-ui/src/components/CriterionAuditHistory.tsx
    apps/hitl-ui/src/components/CriterionCard.tsx
    apps/hitl-ui/src/screens/ReviewPage.tsx
    apps/hitl-ui/src/screens/Dashboard.tsx
  </files>
  <action>
**BUGF-02 Frontend: Update useAuditLog hook and create CriterionAuditHistory component.**

1. **Update useAuditLog hook** in `useReviews.ts`:
   - Add `batchId?: string` parameter to useAuditLog function signature
   - Add batchId to the queryKey array for cache isolation
   - Append `batch_id` to URLSearchParams when batchId is provided
   - Keep backward compatible (batchId is optional)

2. **Create CriterionAuditHistory component** as new file `apps/hitl-ui/src/components/CriterionAuditHistory.tsx`:
   - Import Radix UI Collapsible (already in project dependencies)
   - Import ChevronDown/ChevronRight from lucide-react (already in project)
   - Import useAuditLog from hooks/useReviews
   - Props: `{ criterionId: string }`
   - State: `open` boolean (default false — collapsed per user decision)
   - Call useAuditLog with targetType='criteria' and targetId=criterionId
   - Display entry count in trigger button: "History (N)"
   - Each entry shows: formatAction (Approved/Rejected/Modified), actor, timestamp
   - Show rationale in italic if present
   - Use formatTimestamp with toLocaleString for human-readable dates
   - Keep component under 100 lines (user decision: action summary only, no diffs)
   - Follow the exact component structure from 29-RESEARCH.md "Pattern 4: Frontend Inline Expandable Section"

3. **Integrate into CriterionCard.tsx**:
   - Import CriterionAuditHistory component
   - Add `<CriterionAuditHistory criterionId={criterion.id} />` at the bottom of the card, after existing action buttons
   - No other changes to CriterionCard

4. **Remove or update global audit log usage in ReviewPage.tsx** if it currently calls useAuditLog globally (line ~63). Since audit history is now per-criterion via CriterionAuditHistory, the global audit call in ReviewPage may be unnecessary. Remove it if it served no other purpose, or keep if it powers a separate UI element.

**BUGF-03 Frontend: Update Dashboard pending count display.**

5. **Update Dashboard.tsx** to display criteria-level pending counts:
   - Fetch the pending summary from the new/updated API endpoint
   - Display both counts: "N batches (M criteria) pending review" per user decision
   - Use Claude's discretion on whether to also show per-batch progress (e.g., "12/15 reviewed") in the batch list based on the current dashboard layout

Run frontend type check to verify no TypeScript errors.
  </action>
  <verify>
TypeScript compilation succeeds (`cd apps/hitl-ui && npx tsc --noEmit` or equivalent).
CriterionAuditHistory.tsx exists and is under 100 lines.
CriterionCard.tsx imports and renders CriterionAuditHistory.
useReviews.ts useAuditLog accepts batchId parameter.
Dashboard.tsx displays both pending batches and pending criteria counts.
  </verify>
  <done>
Per-criterion audit history is visible as collapsible "History (N)" section at bottom of each CriterionCard, collapsed by default. useAuditLog hook passes batch_id to the API. Dashboard shows "N batches (M criteria) pending review" using criteria-level counts. Partially reviewed batches appear in pending count.
  </done>
</task>

</tasks>

<verification>
1. `uv run ruff check services/api-service/` — clean
2. `uv run pytest services/api-service/tests/` — all tests pass
3. TypeScript compilation succeeds for hitl-ui
4. CriterionAuditHistory component exists, is under 100 lines, uses Radix Collapsible
5. Audit log API accepts batch_id parameter (grep reviews.py for batch_id)
6. Dashboard displays criteria-level pending count (grep Dashboard.tsx for pending_criteria)
7. Batch status transitions include auto-update to 'reviewed' when all criteria reviewed
</verification>

<success_criteria>
- Audit trail entries visible per-criterion on the Review page (collapsed by default, expandable)
- Dashboard pending count accurately reflects unreviewed criteria across all active batches
- Partially reviewed batches (e.g., 1/41 criteria done) are counted as pending
- Batch status auto-transitions when all criteria are reviewed
- All backend tests pass, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-bug-fixes/29-02-SUMMARY.md`
</output>

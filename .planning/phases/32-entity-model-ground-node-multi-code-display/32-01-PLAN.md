---
phase: 32-entity-model-ground-node-multi-code-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/shared/src/shared/models.py
  - services/grounding-service/src/grounding_service/terminology/__init__.py
  - services/grounding-service/src/grounding_service/terminology/base.py
  - services/grounding-service/src/grounding_service/terminology/rxnorm.py
  - services/grounding-service/src/grounding_service/terminology/icd10.py
  - services/grounding-service/src/grounding_service/terminology/loinc.py
  - services/grounding-service/src/grounding_service/terminology/hpo.py
  - services/api-service/src/api_service/terminology_search.py
  - services/api-service/src/api_service/main.py
autonomous: true

must_haves:
  truths:
    - "Entity model stores multi-system codes (rxnorm_code, icd10_code, loinc_code, hpo_code) alongside existing umls_cui and snomed_code"
    - "Each terminology system has a working HTTP client with disk caching and retry"
    - "Frontend can search each terminology system via proxy API endpoints"
  artifacts:
    - path: "libs/shared/src/shared/models.py"
      provides: "Entity model with new multi-code columns"
      contains: "rxnorm_code"
    - path: "services/grounding-service/src/grounding_service/terminology/base.py"
      provides: "BaseTerminologyClient ABC with search interface"
      contains: "class BaseTerminologyClient"
    - path: "services/grounding-service/src/grounding_service/terminology/rxnorm.py"
      provides: "RxNorm terminology client"
      contains: "class RxNormClient"
    - path: "services/api-service/src/api_service/terminology_search.py"
      provides: "Terminology search proxy endpoints"
      contains: "router"
  key_links:
    - from: "services/api-service/src/api_service/terminology_search.py"
      to: "services/grounding-service/src/grounding_service/terminology/"
      via: "import and call terminology clients"
      pattern: "client\\.search"
---

<objective>
Build the multi-terminology foundation: extend Entity model with new code columns, create terminology HTTP clients for RxNorm/ICD-10/LOINC/HPO (following UmlsClient pattern), and add search proxy endpoints for frontend autocomplete.

Purpose: Establishes the data model and API layer that Plans 02 (ground node) and 03 (UI badges/autocomplete) both depend on.
Output: Entity model with 4 new code columns, 4 terminology clients, and search proxy endpoints.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-CONTEXT.md
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-RESEARCH.md
@libs/shared/src/shared/models.py
@services/umls-mcp-server/src/umls_mcp_server/umls_api.py
@services/api-service/src/api_service/umls_search.py
@services/api-service/src/api_service/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Entity model and create terminology client framework</name>
  <files>
    libs/shared/src/shared/models.py
    services/grounding-service/src/grounding_service/terminology/__init__.py
    services/grounding-service/src/grounding_service/terminology/base.py
    services/grounding-service/src/grounding_service/terminology/rxnorm.py
    services/grounding-service/src/grounding_service/terminology/icd10.py
    services/grounding-service/src/grounding_service/terminology/loinc.py
    services/grounding-service/src/grounding_service/terminology/hpo.py
  </files>
  <action>
**Entity model (libs/shared/src/shared/models.py):**
Add new nullable columns to Entity class (no Alembic migration — per CONTEXT.md, clean migration via drop/recreate):
- `rxnorm_code: str | None = Field(default=None, index=True)`
- `icd10_code: str | None = Field(default=None, index=True)`
- `loinc_code: str | None = Field(default=None, index=True)`
- `hpo_code: str | None = Field(default=None, index=True)`
- `grounding_system: str | None = Field(default=None)` — which terminology system was primary
- `grounding_error: str | None = Field(default=None)` — specific error message for failed grounding

**BaseTerminologyClient ABC (terminology/base.py):**
Create abstract base class with:
- `async def search(self, term: str, limit: int = 5) -> list[TerminologyResult]` — abstract search method
- `TerminologyResult` dataclass with fields: `code: str`, `display: str`, `system: str`, `confidence: float`, `method: str`
- Built-in disk caching via `diskcache.Cache` with configurable TTL (default 7 days)
- Built-in retry via `tenacity.retry` with exponential backoff (3 attempts, 0.5-2s waits)
- `httpx.AsyncClient` instance with 10s timeout

**RxNormClient (terminology/rxnorm.py):**
- Extends BaseTerminologyClient
- Searches NLM RxNorm REST API: `https://rxnav.nlm.nih.gov/REST/drugs.json?name={term}`
- Fallback to approximate match: `https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term={term}`
- Returns best match as TerminologyResult with system="RxNorm"
- No API key required (free public API)

**Icd10Client (terminology/icd10.py):**
- Extends BaseTerminologyClient
- Searches NLM Clinical Tables API: `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms={term}`
- Returns best match with system="ICD-10-CM"
- No API key required

**LoincClient (terminology/loinc.py):**
- Extends BaseTerminologyClient
- Searches NLM Clinical Tables LOINC API: `https://clinicaltables.nlm.nih.gov/api/loincs/v3/search?terms={term}`
- Returns best match with system="LOINC"
- No API key required

**HpoClient (terminology/hpo.py):**
- Extends BaseTerminologyClient
- Searches HPO Monarch API: `https://ontology.jax.org/api/hp/search?q={term}`
- Returns best match with system="HPO"
- No API key required

**Re-exports (__init__.py):**
- Export all clients and TerminologyResult from the package
  </action>
  <verify>
`uv run ruff check libs/shared/ services/grounding-service/` passes clean.
`uv run mypy libs/shared/src/shared/models.py` passes.
`uv run python -c "from grounding_service.terminology import RxNormClient, Icd10Client, LoincClient, HpoClient, TerminologyResult"` succeeds.
  </verify>
  <done>Entity model has 6 new fields (rxnorm_code, icd10_code, loinc_code, hpo_code, grounding_system, grounding_error). Four terminology clients exist with BaseTerminologyClient ABC, disk caching, and retry.</done>
</task>

<task type="auto">
  <name>Task 2: Add terminology search proxy endpoints for frontend autocomplete</name>
  <files>
    services/api-service/src/api_service/terminology_search.py
    services/api-service/src/api_service/main.py
  </files>
  <action>
**Terminology search proxy (api_service/terminology_search.py):**
Create a new FastAPI router (prefix="/api/terminology") with endpoints following the same pattern as the existing umls_search.py:
- `GET /api/terminology/rxnorm/search?q={query}&max_results=5` — search RxNorm via RxNormClient
- `GET /api/terminology/icd10/search?q={query}&max_results=5` — search ICD-10 via Icd10Client
- `GET /api/terminology/loinc/search?q={query}&max_results=5` — search LOINC via LoincClient
- `GET /api/terminology/hpo/search?q={query}&max_results=5` — search HPO via HpoClient

Each endpoint:
- Validates query length >= 3 characters (400 if shorter)
- Validates max_results in range 1-20 (Query param with default=5)
- Returns JSON: `{ "results": [{ "code": "...", "display": "...", "system": "...", "confidence": 0.9 }] }`
- Returns 502 if terminology API fails with error message
- Uses lazy-initialized singleton clients (avoid creating new client per request)

Also diagnose and fix the broken UMLS autocomplete (per CONTEXT.md locked decision: "Current UMLS autocomplete doesn't work correctly — this phase should fix it"):
- Profile the existing GET /api/umls/search endpoint: measure response latency, check if results are correct
- Investigate root causes: check if UmlsClient in umls-mcp-server is returning wrong results, if debounce is too aggressive, if the endpoint has error handling gaps
- Fix identified issues: ensure <500ms latency for typical queries, correct result mapping, proper error handling
- Normalize response format to match `{ "results": [{ "code": "...", "display": "...", "system": "UMLS", "confidence": ... }] }` pattern (consistent with new endpoints)
- If root cause is in UmlsClient backend code (umls_mcp_server/umls_api.py or libs/shared), fix there too — add those files to files_modified as needed

**Register router (api_service/main.py):**
Import and include the terminology_search router in the FastAPI app, alongside the existing umls_search router.
  </action>
  <verify>
`uv run ruff check services/api-service/` passes clean.
`uv run mypy services/api-service/src/api_service/terminology_search.py` passes.
`uv run pytest services/api-service/tests/ -x -q` — existing tests still pass.
  </verify>
  <done>Four terminology search proxy endpoints available at /api/terminology/{system}/search. UMLS search endpoint verified or fixed. All endpoints share consistent response format.</done>
</task>

</tasks>

<verification>
- `uv run ruff check .` passes
- `uv run mypy libs/shared/src/shared/models.py` passes
- Entity model has rxnorm_code, icd10_code, loinc_code, hpo_code, grounding_system, grounding_error fields
- All 4 terminology clients importable from grounding_service.terminology
- All 5 search endpoints (4 new + 1 existing UMLS) return consistent JSON format
- Existing api-service tests still pass
</verification>

<success_criteria>
Entity model extended with multi-code columns. Terminology clients ready for use by ground node (Plan 02) and frontend autocomplete (Plan 03). Search proxy endpoints serving consistent JSON for frontend consumption.
</success_criteria>

<output>
After completion, create `.planning/phases/32-entity-model-ground-node-multi-code-display/32-01-SUMMARY.md`
</output>

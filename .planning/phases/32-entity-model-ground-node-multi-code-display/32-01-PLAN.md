---
phase: 32-entity-model-ground-node-multi-code-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
  - services/protocol-processor-service/src/protocol_processor/config/routing.yaml
  - services/protocol-processor-service/pyproject.toml
  - services/api-service/src/api_service/terminology_search.py
  - services/api-service/src/api_service/main.py
autonomous: true

must_haves:
  truths:
    - "TerminologyRouter _query_tooluniverse returns real candidates from ToolUniverse Python API (or direct NLM API fallback) for RxNorm, ICD-10, LOINC, HPO"
    - "Frontend can search any terminology system via proxy endpoints at /api/terminology/{system}/search"
    - "Existing UMLS/SNOMED direct Python paths remain functional and unchanged"
    - "SNOMED search is available at /api/terminology/snomed/search for use by TerminologyCombobox with system='snomed'"
  artifacts:
    - path: "services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py"
      provides: "Real ToolUniverse or NLM API implementation replacing stub"
      contains: "_query_tooluniverse"
    - path: "services/api-service/src/api_service/terminology_search.py"
      provides: "Search proxy endpoints for RxNorm, ICD-10, LOINC, HPO, UMLS, SNOMED"
      exports: ["router"]
    - path: "services/api-service/src/api_service/main.py"
      provides: "terminology_search router mounted"
      contains: "terminology_search"
  key_links:
    - from: "services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py"
      to: "ToolUniverse or NLM REST APIs"
      via: "_query_tooluniverse method"
      pattern: "_query_tooluniverse"
    - from: "services/api-service/src/api_service/terminology_search.py"
      to: "NLM/ToolUniverse APIs and UMLS client"
      via: "httpx async calls and get_umls_client().search_snomed()"
      pattern: "httpx|AsyncClient|search_snomed"
---

<objective>
Replace the ToolUniverse stub in TerminologyRouter with real terminology API integration, and add search proxy endpoints for frontend autocomplete across all terminology systems including SNOMED.

Purpose: The TerminologyRouter currently returns empty results for RxNorm, ICD-10, LOINC, and HPO lookups (stub). This means entities grounded through those systems get no codes. Additionally, the frontend needs proxy endpoints for per-system autocomplete search — including SNOMED, which TerminologyCombobox uses for Condition entities.

Output: Working TerminologyRouter that returns real terminology candidates, and /api/terminology/{system}/search endpoints for all 6 systems (rxnorm, icd10, loinc, hpo, umls, snomed).
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
@services/protocol-processor-service/src/protocol_processor/config/routing.yaml
@services/protocol-processor-service/pyproject.toml
@services/api-service/src/api_service/umls_search.py
@services/api-service/src/api_service/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement real terminology lookups in TerminologyRouter</name>
  <files>
    services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
    services/protocol-processor-service/src/protocol_processor/config/routing.yaml
    services/protocol-processor-service/pyproject.toml
  </files>
  <action>
Replace the `_query_tooluniverse` stub with real API calls. Per user decision: use ToolUniverse Python API first. If ToolUniverse doesn't have the right medical terminology tools (RxNorm, ICD-10, LOINC, HPO), fall back to direct NLM API calls via httpx.

**Step 1: Try ToolUniverse first.** Check if `tooluniverse` package exists on PyPI. If it does, try to find tools for RxNorm/ICD-10/LOINC/HPO. If ToolUniverse doesn't have these specific tools or the package doesn't exist, proceed to Step 2.

**Step 2: Direct NLM API fallback.** Implement `_query_tooluniverse` (rename to `_query_terminology_api`) using direct HTTP calls to free NLM REST APIs:

- **RxNorm**: `https://rxnav.nlm.nih.gov/REST/drugs.json?name={term}` for exact match, `https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term={term}` for fuzzy. No auth required.
- **ICD-10**: `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms={term}`. No auth required.
- **LOINC**: `https://clinicaltables.nlm.nih.gov/api/loincs/v3/search?sf=LOINC_NUM,LONG_COMMON_NAME&terms={term}`. No auth required.
- **HPO**: `https://ontology.jax.org/api/hp/search?q={term}&max=5`. No auth required.

For each API:
- Use httpx.AsyncClient with 10s timeout
- Add tenacity retry with the existing TransientAPIError pattern (3 attempts, exponential backoff)
- Parse response into list of GroundingCandidate objects
- Cache results using diskcache (7-day TTL, cache dir from platformdirs)
- Handle 429/5xx as TransientAPIError, 4xx as PermanentAPIError

Update routing.yaml: change `source: tooluniverse` to `source: direct_api` for rxnorm, icd10, loinc, hpo. Keep umls/snomed as `source: direct_python`.

Add httpx and diskcache to pyproject.toml dependencies if not already present.

**Important:** Do NOT modify `_query_umls` or `_query_snomed` — they work and must remain unchanged. Only replace the ToolUniverse stub path.
  </action>
  <verify>
`uv run python -c "from protocol_processor.tools.terminology_router import TerminologyRouter; print('import ok')"` succeeds.

Verify the routing.yaml loads correctly:
`uv run python -c "from protocol_processor.tools.terminology_router import TerminologyRouter; r = TerminologyRouter(); print(r.get_apis_for_entity('Medication')); print(r.get_apis_for_entity('Condition'))"` shows correct API lists.
  </verify>
  <done>
TerminologyRouter._query_tooluniverse (or renamed method) makes real HTTP calls to NLM APIs for RxNorm, ICD-10, LOINC, HPO. Returns GroundingCandidate objects with code, preferred_term, and score. Existing UMLS/SNOMED paths unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add terminology search proxy endpoints for frontend (including SNOMED)</name>
  <files>
    services/api-service/src/api_service/terminology_search.py
    services/api-service/src/api_service/main.py
  </files>
  <action>
Create a new FastAPI router `terminology_search.py` in api-service that provides search proxy endpoints for ALL terminology systems. This enables frontend TerminologyCombobox to search any system — including SNOMED, which is required for Condition entities in Plan 03.

**Endpoints:**

`GET /api/terminology/{system}/search?q={term}&max_results=5`

Where `{system}` is one of: `rxnorm`, `icd10`, `loinc`, `hpo`, `umls`, `snomed`.

**Response model:**
```python
class TerminologySearchResult(BaseModel):
    code: str           # RxCUI, ICD-10 code, LOINC code, HPO code, CUI, or SNOMED code
    display: str        # Preferred term / display name
    system: str         # "rxnorm", "icd10", "loinc", "hpo", "umls", or "snomed"
    semantic_type: str | None = None
    confidence: float = 1.0
```

**Implementation for each system:**
- `rxnorm`: Call RxNorm REST API directly (`https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term={q}`)
- `icd10`: Call NLM Clinical Tables ICD-10 API (`https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms={q}`)
- `loinc`: Call NLM Clinical Tables LOINC API (`https://clinicaltables.nlm.nih.gov/api/loincs/v3/search?sf=LOINC_NUM,LONG_COMMON_NAME&terms={q}`)
- `hpo`: Call JAX HPO API (`https://ontology.jax.org/api/hp/search?q={q}&max={max_results}`)
- `umls`: Delegate to existing `umls_search.py` logic (use `get_umls_client().search_umls()` or equivalent)
- `snomed`: Delegate to existing UMLS client SNOMED search via `get_umls_client().search_snomed()` — this uses the already-working SNOMED path from umls_search.py

Use httpx (async, since FastAPI endpoint should be `async def`) with 10s timeout. Add query validation: min 3 chars (matching existing UMLS search). Return 400 with detail message if `{system}` is not one of the 6 valid values.

**Mount the router** in main.py alongside the existing UMLS search router. The existing `/api/umls/search` endpoint must continue working unchanged — the new `/api/terminology/umls/search` and `/api/terminology/snomed/search` endpoints provide the same data in the unified format.

Model error handling after the existing `umls_search.py` patterns: proper HTTPException, logging, try/except for API errors.
  </action>
  <verify>
Server starts: `uv run uvicorn api_service.main:app --port 8001` boots without errors.

Test endpoint (if server running):
- `curl "http://localhost:8001/api/terminology/rxnorm/search?q=aspirin"` returns JSON array of results.
- `curl "http://localhost:8001/api/terminology/snomed/search?q=diabetes"` returns JSON array of SNOMED results (not 404).
- `curl "http://localhost:8001/api/terminology/invalid/search?q=test"` returns 400.
  </verify>
  <done>
Six search proxy endpoints available at /api/terminology/{system}/search for rxnorm, icd10, loinc, hpo, umls, snomed. Each returns TerminologySearchResult objects. SNOMED endpoint delegates to get_umls_client().search_snomed(). Existing /api/umls/search endpoint unchanged.
  </done>
</task>

</tasks>

<verification>
- `uv run ruff check services/protocol-processor-service/src/ services/api-service/src/api_service/terminology_search.py` passes
- TerminologyRouter imports successfully with real API methods
- All 6 terminology search proxy endpoints are registered in the FastAPI app (rxnorm, icd10, loinc, hpo, umls, snomed)
- `/api/terminology/snomed/search` returns results (not 404)
- Existing UMLS search endpoint `/api/umls/search` still works
</verification>

<success_criteria>
- TerminologyRouter returns real GroundingCandidate results for RxNorm, ICD-10, LOINC, HPO entities (not empty stubs)
- Frontend search proxies available at /api/terminology/{system}/search for all 6 systems (rxnorm, icd10, loinc, hpo, umls, snomed)
- SNOMED search endpoint delegates to get_umls_client().search_snomed() and returns results
- No changes to existing UMLS/SNOMED direct Python paths in the protocol-processor-service
</success_criteria>

<output>
After completion, create `.planning/phases/32-entity-model-ground-node-multi-code-display/32-01-SUMMARY.md`
</output>

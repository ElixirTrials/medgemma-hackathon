---
phase: 32-entity-model-ground-node-multi-code-display
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - apps/hitl-ui/src/components/TerminologyBadge.tsx
  - apps/hitl-ui/src/components/TerminologyCombobox.tsx
  - apps/hitl-ui/src/components/EntityCard.tsx
  - apps/hitl-ui/src/hooks/useTerminologySearch.ts
  - apps/hitl-ui/src/hooks/useEntities.ts
  - apps/hitl-ui/src/screens/ProtocolDetail.tsx
autonomous: true

must_haves:
  truths:
    - "All resolved terminology codes (RxNorm, ICD-10, SNOMED, LOINC, HPO, UMLS CUI) are visible as color-coded badges on each entity"
    - "User can modify any terminology code via per-system autocomplete search"
    - "Failed grounding shows red badge with specific error reason"
    - "Retry button on ProtocolDetail resumes from failed node (not full restart)"
    - "Existing UMLS autocomplete is fixed and working with proper debouncing"
  artifacts:
    - path: "apps/hitl-ui/src/components/TerminologyBadge.tsx"
      provides: "Color-coded badge component for each terminology system"
      contains: "SYSTEM_COLORS"
    - path: "apps/hitl-ui/src/components/TerminologyCombobox.tsx"
      provides: "Reusable per-system autocomplete combobox"
      contains: "TerminologyCombobox"
    - path: "apps/hitl-ui/src/hooks/useTerminologySearch.ts"
      provides: "Hook for searching any terminology system via proxy endpoints"
      contains: "useTerminologySearch"
    - path: "apps/hitl-ui/src/components/EntityCard.tsx"
      provides: "Updated entity card with multi-code badges and per-system editing"
      contains: "TerminologyBadge"
  key_links:
    - from: "apps/hitl-ui/src/hooks/useTerminologySearch.ts"
      to: "/api/terminology/{system}/search"
      via: "fetch with debounced query"
      pattern: "api/terminology"
    - from: "apps/hitl-ui/src/components/EntityCard.tsx"
      to: "apps/hitl-ui/src/components/TerminologyBadge.tsx"
      via: "import and render per code field"
      pattern: "TerminologyBadge"
    - from: "apps/hitl-ui/src/components/EntityCard.tsx"
      to: "apps/hitl-ui/src/components/TerminologyCombobox.tsx"
      via: "render in edit mode for each system"
      pattern: "TerminologyCombobox"
---

<objective>
Display multi-terminology code badges on EntityCard, add per-system autocomplete editing, fix UMLS autocomplete, and update retry button text.

Purpose: Users need to see all grounding codes per entity at a glance with visual system differentiation, modify any code via working autocomplete, and understand what retry does (resume from failure, not full restart).

Output: TerminologyBadge component, TerminologyCombobox component, updated EntityCard with multi-code display and editing, updated retry UX.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/hitl-ui/src/components/EntityCard.tsx
@apps/hitl-ui/src/components/UmlsCombobox.tsx
@apps/hitl-ui/src/hooks/useUmlsSearch.ts
@apps/hitl-ui/src/hooks/useEntities.ts
@apps/hitl-ui/src/screens/ProtocolDetail.tsx
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TerminologyBadge, TerminologyCombobox, and useTerminologySearch</name>
  <files>
    apps/hitl-ui/src/components/TerminologyBadge.tsx
    apps/hitl-ui/src/components/TerminologyCombobox.tsx
    apps/hitl-ui/src/hooks/useTerminologySearch.ts
  </files>
  <action>
**TerminologyBadge.tsx:** Create a color-coded badge component for terminology codes. Per user decision (colors at Claude's discretion):

```typescript
type TerminologySystem = 'rxnorm' | 'icd10' | 'snomed' | 'loinc' | 'hpo' | 'umls';

const SYSTEM_COLORS: Record<TerminologySystem, string> = {
    rxnorm: 'bg-blue-100 text-blue-800 border-blue-300',
    icd10: 'bg-orange-100 text-orange-800 border-orange-300',
    snomed: 'bg-green-100 text-green-800 border-green-300',
    loinc: 'bg-purple-100 text-purple-800 border-purple-300',
    hpo: 'bg-teal-100 text-teal-800 border-teal-300',
    umls: 'bg-indigo-100 text-indigo-800 border-indigo-300',
};

const SYSTEM_LABELS: Record<TerminologySystem, string> = {
    rxnorm: 'RxNorm',
    icd10: 'ICD-10',
    snomed: 'SNOMED',
    loinc: 'LOINC',
    hpo: 'HPO',
    umls: 'CUI',
};
```

Props: `system`, `code`, `display?` (optional preferred term shown in parentheses). Render as a rounded-full pill badge with border.

Also add an `ErrorBadge` component for grounding_error: red background, shows "Failed: {error_reason}" text.

**useTerminologySearch.ts:** Create a generic hook that works for ANY terminology system, reusing the pattern from useUmlsSearch.ts but pointing to the new unified endpoint:

```typescript
export function useTerminologySearch(system: TerminologySystem, query: string) {
    // 300ms debounce (same as existing UMLS)
    // Min 3 chars
    // Calls /api/terminology/{system}/search?q={query}
    // Returns { results: TerminologySearchResult[], isLoading, isError }
    // 5-minute staleTime cache
}
```

Interface: `TerminologySearchResult { code: string; display: string; system: string; semantic_type?: string; confidence: number }`

**TerminologyCombobox.tsx:** Create a reusable per-system autocomplete component. Model after UmlsCombobox.tsx but generic:

Props:
- `system: TerminologySystem` — which terminology to search
- `value: string` — current display value
- `onSelect: (result: TerminologySearchResult) => void` — called when user selects a result
- `onChange: (value: string) => void` — called on text input change
- `placeholder?: string`

Use Radix Popover + cmdk Command (already in project, same as UmlsCombobox). Show system-specific label in the search placeholder (e.g., "Search RxNorm..."). Show code + display name in results dropdown.

Use `useTerminologySearch(system, inputValue)` internally. The hook handles debouncing.
  </action>
  <verify>
`npx tsc --noEmit` from apps/hitl-ui/ passes (or has no new errors).

Manually verify file structure: TerminologyBadge.tsx, TerminologyCombobox.tsx, and useTerminologySearch.ts all exist.
  </verify>
  <done>
TerminologyBadge renders color-coded pills for any system. TerminologyCombobox provides per-system autocomplete search. useTerminologySearch hook queries /api/terminology/{system}/search with debouncing and caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update EntityCard with multi-code badges and per-system editing</name>
  <files>
    apps/hitl-ui/src/components/EntityCard.tsx
    apps/hitl-ui/src/hooks/useEntities.ts
    apps/hitl-ui/src/screens/ProtocolDetail.tsx
  </files>
  <action>
**useEntities.ts:** Update EntityResponse interface to include multi-code fields:

```typescript
export interface EntityResponse {
    // ... existing fields ...
    rxnorm_code: string | null;
    icd10_code: string | null;
    loinc_code: string | null;
    hpo_code: string | null;
    grounding_system: string | null;
    grounding_error: string | null;
}
```

Update EntityActionRequest to support modifying any code field:

```typescript
export interface EntityActionRequest {
    action: 'approve' | 'reject' | 'modify';
    reviewer_id: string;
    modified_umls_cui?: string;
    modified_snomed_code?: string;
    modified_preferred_term?: string;
    modified_rxnorm_code?: string;
    modified_icd10_code?: string;
    modified_loinc_code?: string;
    modified_hpo_code?: string;
    comment?: string;
}
```

**EntityCard.tsx:** Major update to show multi-code badges and per-system editing:

1. **Read mode — Replace existing SNOMED/UMLS badge sections** with a unified `EntityCodeBadges` section that renders TerminologyBadge for each non-null code:
   - `entity.rxnorm_code` -> TerminologyBadge system="rxnorm"
   - `entity.icd10_code` -> TerminologyBadge system="icd10"
   - `entity.snomed_code` -> TerminologyBadge system="snomed" display={entity.preferred_term}
   - `entity.loinc_code` -> TerminologyBadge system="loinc"
   - `entity.hpo_code` -> TerminologyBadge system="hpo"
   - `entity.umls_cui` -> TerminologyBadge system="umls" (keep the link to uts.nlm.nih.gov)
   - `entity.grounding_error` -> ErrorBadge (red pill with error text)

   Show badges in a flex-wrap row. If no codes and no error, show a gray "Not grounded" badge.

2. **Edit mode — Replace the UmlsCombobox section** with per-system TerminologyCombobox fields. Show a TerminologyCombobox for each system relevant to the entity type:
   - Determine relevant systems from entity_type (Medication -> rxnorm, Condition -> icd10+snomed, Lab_Value -> loinc, Biomarker -> hpo)
   - Always show UMLS combobox (via the new TerminologyCombobox with system="umls")
   - Each combobox updates its corresponding edit state field
   - Keep manual text input fallback for CUI and SNOMED (like existing)

   Manage edit state with individual useState hooks for each code field:
   ```typescript
   const [editRxnorm, setEditRxnorm] = useState(entity.rxnorm_code ?? '');
   const [editIcd10, setEditIcd10] = useState(entity.icd10_code ?? '');
   const [editLoinc, setEditLoinc] = useState(entity.loinc_code ?? '');
   const [editHpo, setEditHpo] = useState(entity.hpo_code ?? '');
   ```

3. **handleModifySave:** Include all code fields in the EntityActionRequest:
   ```typescript
   modified_rxnorm_code: editRxnorm || undefined,
   modified_icd10_code: editIcd10 || undefined,
   modified_loinc_code: editLoinc || undefined,
   modified_hpo_code: editHpo || undefined,
   ```

4. **handleModifyCancel:** Reset all code edit states to entity values.

**ProtocolDetail.tsx:** Update RetryButton text from "Retry Extraction" to "Retry Processing" since retry now resumes from any failed node, not just extraction. The button already calls useRetryProtocol which hits the correct endpoint. No other changes needed — the retry endpoint update (Plan 02) handles the checkpoint resume backend logic.

Also add "processing" to the STATUS_COLORS and STATUS_LABELS maps if not already present:
```typescript
processing: 'bg-blue-100 text-blue-800',
```
  </action>
  <verify>
`npx tsc --noEmit` from apps/hitl-ui/ passes (or has no new errors vs baseline).

`npm run build` from apps/hitl-ui/ succeeds.
  </verify>
  <done>
EntityCard shows color-coded TerminologyBadge for each resolved code. Edit mode shows per-system TerminologyCombobox autocomplete. Failed grounding shows red ErrorBadge. RetryButton says "Retry Processing". All codes are user-modifiable.
  </done>
</task>

</tasks>

<verification>
- `npm run build` from apps/hitl-ui/ succeeds without errors
- TerminologyBadge renders with correct colors per system
- EntityCard displays all non-null code fields as badges
- Edit mode provides per-system autocomplete via TerminologyCombobox
- ErrorBadge shows grounding_error when present
- RetryButton text updated to "Retry Processing"
- Existing UmlsCombobox still available (not deleted, just superseded in EntityCard)
</verification>

<success_criteria>
- All 6 terminology systems (RxNorm, ICD-10, SNOMED, LOINC, HPO, UMLS) display as color-coded badges when codes are present
- Per-system autocomplete search works via /api/terminology/{system}/search proxy
- Grounding errors shown as red "Failed" badge with specific error reason
- Retry button text reflects checkpoint-based resume behavior
- No deferred features implemented (no real-time progress, no re-process option)
</success_criteria>

<output>
After completion, create `.planning/phases/32-entity-model-ground-node-multi-code-display/32-03-SUMMARY.md`
</output>

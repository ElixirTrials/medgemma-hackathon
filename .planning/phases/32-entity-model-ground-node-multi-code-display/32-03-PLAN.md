---
phase: 32-entity-model-ground-node-multi-code-display
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - apps/hitl-ui/src/components/TerminologyBadge.tsx
  - apps/hitl-ui/src/components/TerminologyCombobox.tsx
  - apps/hitl-ui/src/hooks/useTerminologySearch.ts
  - apps/hitl-ui/src/components/EntityCard.tsx
  - apps/hitl-ui/src/screens/ProtocolDetail.tsx
  - apps/hitl-ui/src/hooks/useProtocols.ts
autonomous: true

must_haves:
  truths:
    - "Multi-terminology codes (RxNorm, ICD-10, LOINC, HPO, SNOMED, UMLS CUI) are visible per entity as color-coded badges"
    - "All terminology codes are user-modifiable with per-system autocomplete search"
    - "Failed protocols show red Failed badge with specific error reason and a Retry button"
    - "Graceful fallback when codes are missing (no empty badges, no crashes for pre-existing data)"
  artifacts:
    - path: "apps/hitl-ui/src/components/TerminologyBadge.tsx"
      provides: "Color-coded badge component for each terminology system"
      contains: "SYSTEM_COLORS"
    - path: "apps/hitl-ui/src/components/TerminologyCombobox.tsx"
      provides: "Per-system autocomplete combobox"
      contains: "TerminologyCombobox"
    - path: "apps/hitl-ui/src/hooks/useTerminologySearch.ts"
      provides: "Debounced terminology search hook"
      contains: "useTerminologySearch"
    - path: "apps/hitl-ui/src/components/EntityCard.tsx"
      provides: "Updated EntityCard with multi-code badges and per-system autocomplete"
      contains: "TerminologyBadge"
  key_links:
    - from: "apps/hitl-ui/src/hooks/useTerminologySearch.ts"
      to: "/api/terminology/{system}/search"
      via: "fetch with debounce"
      pattern: "api/terminology"
    - from: "apps/hitl-ui/src/components/EntityCard.tsx"
      to: "apps/hitl-ui/src/components/TerminologyBadge.tsx"
      via: "render badges for each code"
      pattern: "TerminologyBadge"
    - from: "apps/hitl-ui/src/screens/ProtocolDetail.tsx"
      to: "/protocols/{id}/retry"
      via: "retry mutation"
      pattern: "retry"
---

<objective>
Display multi-terminology code badges per entity, add per-system autocomplete for editing codes, fix broken UMLS autocomplete, and add retry button for failed protocols.

Purpose: Makes grounding results visible and editable — reviewers see all resolved codes per entity and can correct any grounding via autocomplete. Failed pipelines are retryable from the UI.
Output: TerminologyBadge, TerminologyCombobox, updated EntityCard, retry UX.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-CONTEXT.md
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-RESEARCH.md
@.planning/phases/32-entity-model-ground-node-multi-code-display/32-01-SUMMARY.md
@.planning/phases/25-umls-concept-search-autocomplete/25-02-SUMMARY.md
@apps/hitl-ui/src/components/EntityCard.tsx
@apps/hitl-ui/src/components/UmlsCombobox.tsx
@apps/hitl-ui/src/hooks/useUmlsSearch.ts
@apps/hitl-ui/src/screens/ProtocolDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TerminologyBadge and useTerminologySearch hook</name>
  <files>
    apps/hitl-ui/src/components/TerminologyBadge.tsx
    apps/hitl-ui/src/hooks/useTerminologySearch.ts
  </files>
  <action>
**TerminologyBadge (components/TerminologyBadge.tsx):**
Create a reusable badge component for displaying terminology codes:
- Props: `system: 'rxnorm' | 'icd10' | 'snomed' | 'loinc' | 'hpo' | 'umls'`, `code: string`, `display?: string`
- Color scheme per system (Claude's discretion, suggested from RESEARCH.md):
  - RxNorm = blue (bg-blue-100 text-blue-800 border-blue-300)
  - ICD-10 = orange (bg-orange-100 text-orange-800 border-orange-300)
  - SNOMED = green (bg-green-100 text-green-800 border-green-300)
  - LOINC = purple (bg-purple-100 text-purple-800 border-purple-300)
  - HPO = teal (bg-teal-100 text-teal-800 border-teal-300)
  - UMLS CUI = indigo (bg-indigo-100 text-indigo-800 border-indigo-300)
- Export SYSTEM_COLORS and SYSTEM_LABELS constants for reuse
- Render: `<span>` pill with `{Label}: {code}` and optional `(display)` suffix
- Use Tailwind classes, keep consistent with existing badge styling

**useTerminologySearch hook (hooks/useTerminologySearch.ts):**
Create a generic terminology search hook following the same pattern as existing useUmlsSearch:
- Parameters: `system: string`, `query: string`
- Debounces query by 150ms for fast APIs (RxNorm, LOINC, ICD-10) and 300ms for slower APIs (HPO, UMLS)
  - Use system to determine debounce time
- Only enables query when debouncedQuery has 3+ characters
- Fetches from `/api/terminology/{system}/search?q={debouncedQuery}` (or `/api/umls/search?q=` for UMLS system)
- Returns `{ results, isLoading, isError }` — same interface as useUmlsSearch
- TanStack Query with 5-min staleTime, AbortController signal for cancellation
- Single retry on failure
  </action>
  <verify>
`cd apps/hitl-ui && npx tsc --noEmit` passes.
`cd apps/hitl-ui && npx biome check src/components/TerminologyBadge.tsx src/hooks/useTerminologySearch.ts` passes.
  </verify>
  <done>TerminologyBadge renders color-coded pills per terminology system. useTerminologySearch hook provides debounced search for any terminology system with consistent interface.</done>
</task>

<task type="auto">
  <name>Task 2: Create TerminologyCombobox and update EntityCard with multi-code display + editing</name>
  <files>
    apps/hitl-ui/src/components/TerminologyCombobox.tsx
    apps/hitl-ui/src/components/EntityCard.tsx
  </files>
  <action>
**TerminologyCombobox (components/TerminologyCombobox.tsx):**
Create a per-system autocomplete component following the same pattern as existing UmlsCombobox:
- Props: `system: string`, `value: string`, `onSelect: (result: { code: string, display: string }) => void`, `placeholder?: string`
- Uses useTerminologySearch hook for debounced search
- cmdk + Radix Popover for accessible dropdown (same pattern as UmlsCombobox)
- Dropdown items show: code (bold) + display name
- Loading/empty/no-results states
- `shouldFilter={false}` (server-side filtering)
- Selecting an item calls onSelect with code and display

**EntityCard update (components/EntityCard.tsx):**
Update EntityCard to display multi-code badges and provide per-system autocomplete editing:

**Read mode (not editing):**
- Below existing entity text, render a `flex flex-wrap gap-2` container with TerminologyBadge for each non-null code:
  - `entity.rxnorm_code` → `<TerminologyBadge system="rxnorm" code={...} />`
  - `entity.icd10_code` → `<TerminologyBadge system="icd10" code={...} />`
  - `entity.snomed_code` → `<TerminologyBadge system="snomed" code={...} display={entity.preferred_term} />`
  - `entity.loinc_code` → `<TerminologyBadge system="loinc" code={...} />`
  - `entity.hpo_code` → `<TerminologyBadge system="hpo" code={...} />`
  - `entity.umls_cui` → `<TerminologyBadge system="umls" code={...} />`
- If entity.grounding_error, show red error badge: "Failed: {error message}"
- Graceful fallback: only render badges for codes that exist (no empty badges)

**Edit/modify mode:**
- Replace the current single UmlsCombobox with multiple TerminologyCombobox instances based on entity type
- Show relevant autocomplete fields based on entity_type:
  - Medication: RxNorm + UMLS autocomplete
  - Condition: SNOMED + ICD-10 + UMLS autocomplete
  - Lab_Value: LOINC + UMLS autocomplete
  - Biomarker: HPO + UMLS autocomplete
  - Procedure: UMLS autocomplete only
  - Demographic: No autocomplete (display "Demographics are not grounded")
- Each TerminologyCombobox updates its specific code field in edit state
- Keep existing Save/Cancel button behavior
- On Save, send all code fields via the existing modify action mutation (update the mutation payload to include new code fields)

**Update TypeScript types:**
- Add rxnorm_code, icd10_code, loinc_code, hpo_code, grounding_system, grounding_error to the EntityResponse type (wherever entity types are defined in the frontend)
  </action>
  <verify>
`cd apps/hitl-ui && npx tsc --noEmit` passes.
`cd apps/hitl-ui && npx biome check src/components/` passes.
`cd apps/hitl-ui && npm run build` succeeds (production build).
  </verify>
  <done>EntityCard displays color-coded badges for all resolved terminology codes in read mode. Edit mode provides per-system autocomplete for modifying codes based on entity type. TypeScript types updated for new entity fields.</done>
</task>

<task type="auto">
  <name>Task 3: Add retry button for failed protocols</name>
  <files>
    apps/hitl-ui/src/screens/ProtocolDetail.tsx
    apps/hitl-ui/src/hooks/useProtocols.ts
  </files>
  <action>
**Retry mutation (hooks/useProtocols.ts or similar):**
- Add a `useRetryProtocol` mutation hook using TanStack Query useMutation:
  - `mutationFn`: POST to `/protocols/{id}/retry`
  - `onSuccess`: invalidate protocol queries to refresh status
  - Returns { mutate, isPending } for button state

**Protocol detail retry UX (screens/ProtocolDetail.tsx or wherever protocol status is shown):**
- When protocol status is "extraction_failed" or "grounding_failed":
  - Show a red "Failed" badge with the specific error reason from `protocol.error_reason`
  - Show a "Retry" button next to the badge
  - While retrying: show spinner, disable button, display "Retrying..."
  - Per CONTEXT.md: "Simple processing spinner only (no real-time node progress)"
  - On retry success: status refreshes automatically via query invalidation
  - On retry failure: show error toast/message

**Dashboard protocol list (if applicable):**
- Failed protocols should show the red badge in the protocol list as well
- This may already be handled by existing status badge logic; verify and update if needed

Per CONTEXT.md deferred: Do NOT implement real-time pipeline progress (SSE/WebSocket) or full re-process option.
  </action>
  <verify>
`cd apps/hitl-ui && npx tsc --noEmit` passes.
`cd apps/hitl-ui && npm run build` succeeds.
  </verify>
  <done>Failed protocols show red "Failed" badge with error reason and Retry button. Retry invokes checkpoint-based resume (not full pipeline restart). Spinner shown during retry.</done>
</task>

</tasks>

<verification>
- `cd apps/hitl-ui && npx tsc --noEmit` passes
- `cd apps/hitl-ui && npx biome check src/` passes
- `cd apps/hitl-ui && npm run build` succeeds
- EntityCard renders TerminologyBadge for each non-null code
- EntityCard edit mode shows relevant TerminologyCombobox fields per entity type
- Failed protocols show error badge + retry button
- No badges rendered for null/missing codes (graceful fallback)
</verification>

<success_criteria>
Multi-terminology codes visible per entity as color-coded badges. All codes editable via per-system autocomplete. Failed protocols retryable from UI. Graceful fallback for missing codes and pre-existing data.
</success_criteria>

<output>
After completion, create `.planning/phases/32-entity-model-ground-node-multi-code-display/32-03-SUMMARY.md`
</output>

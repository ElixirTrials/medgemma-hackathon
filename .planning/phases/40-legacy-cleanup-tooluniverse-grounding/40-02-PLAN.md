---
phase: 40-legacy-cleanup-tooluniverse-grounding
plan: 02
type: execute
wave: 2
depends_on:
  - 40-01
files_modified: []
autonomous: false
requirements:
  - CLEAN-04
  - CLEAN-05

must_haves:
  truths:
    - "Running the pipeline on a test PDF produces entities with non-zero CUI/code values"
    - "At least one entity is grounded via ToolUniverse with a real terminology code (CUI, ICD-10, LOINC, RxNorm, or HPO ID)"
    - "ToolUniverse error responses (missing UMLS_API_KEY) are logged as warnings, not silent failures"
    - "Autocomplete endpoint returns results within acceptable latency (cached < 100ms)"
  artifacts: []
  key_links:
    - from: "services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py"
      to: "services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py"
      via: "Live ToolUniverse API calls produce real grounding results"
      pattern: "search_terminology"
---

<objective>
Verify end-to-end that the ToolUniverse integration actually produces grounded entities with real terminology codes by running the pipeline on a test PDF and checking the autocomplete endpoints.

Purpose: CLEAN-04 requires >0% CUI rate. This plan proves the integration works live, not just in unit tests. The old pipeline had 0% CUI rate because `_query_umls` called a nonexistent `concept_search` method. This verification confirms ToolUniverse fixes that.

Output: Verified pipeline grounding with real CUI/codes, confirmed autocomplete latency with cache.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-legacy-cleanup-tooluniverse-grounding/40-RESEARCH.md
@.planning/phases/40-legacy-cleanup-tooluniverse-grounding/40-01-SUMMARY.md
@services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py
@services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run pipeline on test PDF and verify grounding codes</name>
  <files></files>
  <action>
    **Pre-requisite check:** Ensure Docker Compose stack is running with PostgreSQL and all services up. If not running, start it:
    ```bash
    docker compose -f infra/docker-compose.yml up -d
    ```
    Wait for services to be healthy.

    **Step 1: Verify UMLS_API_KEY is set**
    Check `.env` for `UMLS_API_KEY`. If not set, log a warning but proceed — ICD10, LOINC, RxNorm, and HPO do NOT require it. UMLS and SNOMED will return empty results without it, which is acceptable for verification as long as at least one non-UMLS system returns results.

    **Step 2: Run pipeline on a test PDF**
    Use one of the existing PDFs in `data/protocols/` (pick the smallest one). Trigger pipeline via the API:
    ```bash
    # Upload and process a test protocol
    curl -s http://localhost:8000/api/protocols/ | python -m json.tool
    ```
    If no protocols exist, upload one. Then trigger extraction and wait for grounding to complete.

    Alternatively, use inline Python to verify ToolUniverse (no test script file needed):
    ```bash
    cd /Users/noahdolevelixir/Code/medgemma-hackathon && uv run python -c "
    from protocol_processor.tools.tooluniverse_client import search_terminology
    import sys
    systems = [('icd10', 'hypertension'), ('rxnorm', 'metformin'), ('hpo', 'seizure')]
    for system, query in systems:
        results = search_terminology(system, query, max_results=5)
        print(f'{system}: {len(results)} results')
        for r in results:
            print(f'  {r.code} - {r.preferred_term}')
        assert len(results) > 0, f'FAIL: no {system} results'
    # UMLS needs UMLS_API_KEY — may return empty, that's OK
    umls = search_terminology('umls', 'diabetes', max_results=5)
    print(f'umls: {len(umls)} results (needs UMLS_API_KEY)')
    print('PASS: ToolUniverse grounding verified for non-UMLS systems')
    "
    ```

    **Step 3: Verify autocomplete endpoints**
    ```bash
    # Test terminology search endpoint
    curl -s "http://localhost:8000/api/terminology/icd10/search?q=hypertension&max_results=5" | python -m json.tool

    # Test UMLS search endpoint (may return empty without UMLS_API_KEY)
    curl -s "http://localhost:8000/api/umls/search?q=diabetes&max_results=5" | python -m json.tool
    ```

    **Step 4: Verify caching**
    Run the same autocomplete query twice and compare response times. Second call should be near-instant from TTLCache.

    **Step 5: Check error handling**
    If UMLS_API_KEY is not set, verify that:
    - `search_terminology("umls", ...)` returns empty list (not an exception)
    - A warning is logged mentioning the error from ToolUniverse
    - Non-UMLS systems (icd10, loinc, rxnorm, hpo) still return results
  </action>
  <verify>
    ```bash
    # Quick smoke test that ToolUniverse client can be imported and called
    cd /Users/noahdolevelixir/Code/medgemma-hackathon && uv run python -c "
    from protocol_processor.tools.tooluniverse_client import search_terminology
    results = search_terminology('icd10', 'hypertension', max_results=3)
    print(f'ICD10 results: {len(results)}')
    for r in results:
        print(f'  {r.code} - {r.preferred_term}')
    assert len(results) > 0, 'FAIL: no ICD10 results'
    print('PASS: ToolUniverse grounding works')
    "
    ```
  </verify>
  <done>
    At least one terminology system (ICD10, RxNorm, or HPO) returns real grounding codes via ToolUniverse. CUI rate is >0% for non-UMLS-requiring systems. Autocomplete endpoints return results. Error handling for missing UMLS_API_KEY is graceful (empty results + warning log, not crash).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of full ToolUniverse integration</name>
  <files></files>
  <action>
    Present verification steps to the user. What was built: Complete legacy service deletion and ToolUniverse integration across the entire codebase. All 3 legacy services deleted, TerminologyRouter rewritten, API endpoints rewritten, tests rewritten, and live ToolUniverse grounding verified.

    Steps for user to verify:
    1. Confirm `services/grounding-service/`, `services/extraction-service/`, `services/umls-mcp-server/` are gone
    2. Run `uv run pytest services/api-service/tests/ services/protocol-processor-service/tests/ -x -q` -- all tests pass
    3. Run `grep -r "from umls_mcp_server\|from grounding_service\|from extraction_service" services/` -- no results
    4. Check autocomplete: `curl "http://localhost:8000/api/terminology/icd10/search?q=hypertension&max_results=3"` returns real ICD-10 codes
    5. If UMLS_API_KEY is configured: `curl "http://localhost:8000/api/umls/search?q=diabetes&max_results=3"` returns CUI codes
    6. Review the 40-01-SUMMARY.md for completeness
  </action>
  <verify>User types "approved" or describes issues</verify>
  <done>User confirms end-to-end ToolUniverse integration is working correctly</done>
</task>

</tasks>

<verification>
1. `uv run python -c "from protocol_processor.tools.tooluniverse_client import search_terminology; r = search_terminology('icd10', 'hypertension'); assert len(r) > 0"` -- live grounding works
2. At least 3 of 6 terminology systems return non-empty results (icd10, rxnorm, hpo do not require UMLS_API_KEY)
3. Autocomplete endpoints respond with results matching the query term
4. No Python exceptions or crashes when UMLS_API_KEY is missing (graceful degradation)
</verification>

<success_criteria>
- Pipeline produces entities with >0% CUI rate (CLEAN-04)
- At least ICD10, RxNorm, and HPO return real terminology codes via ToolUniverse
- Autocomplete endpoints functional with ToolUniverse backend
- Human verification confirms the full integration works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/40-legacy-cleanup-tooluniverse-grounding/40-02-SUMMARY.md`
</output>

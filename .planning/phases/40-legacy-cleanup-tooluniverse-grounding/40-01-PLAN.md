---
phase: 40-legacy-cleanup-tooluniverse-grounding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - infra/docker-compose.yml
  - services/api-service/pyproject.toml
  - services/api-service/src/api_service/umls_search.py
  - services/api-service/src/api_service/terminology_search.py
  - services/api-service/src/api_service/main.py
  - services/api-service/tests/test_schemas.py
  - services/api-service/tests/test_umls_clients.py
  - services/protocol-processor-service/pyproject.toml
  - services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py
  - services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
  - services/protocol-processor-service/src/protocol_processor/config/routing.yaml
autonomous: true
requirements:
  - CLEAN-01
  - CLEAN-02
  - CLEAN-03

must_haves:
  truths:
    - "services/grounding-service/, services/extraction-service/, and services/umls-mcp-server/ directories no longer exist"
    - "No Python file in the repo imports from grounding_service, extraction_service, or umls_mcp_server"
    - "TerminologyRouter dispatches all 6 systems (umls, snomed, icd10, loinc, rxnorm, hpo) through ToolUniverse SDK"
    - "/api/umls/search and /api/terminology/{system}/search endpoints use ToolUniverse backend"
    - "uv sync succeeds without errors after workspace member removal"
    - "uv run pytest services/api-service and services/protocol-processor-service pass with no import errors"
  artifacts:
    - path: "services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py"
      provides: "Singleton ToolUniverse wrapper with TTLCache"
      contains: "search_terminology"
    - path: "services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py"
      provides: "Rewritten TerminologyRouter using ToolUniverse"
      contains: "_query_tooluniverse"
    - path: "services/protocol-processor-service/src/protocol_processor/config/routing.yaml"
      provides: "All api_configs pointing to tooluniverse source"
      contains: "tooluniverse"
  key_links:
    - from: "services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py"
      to: "services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py"
      via: "import search_terminology"
      pattern: "from protocol_processor\\.tools\\.tooluniverse_client import search_terminology"
    - from: "services/api-service/src/api_service/terminology_search.py"
      to: "services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py"
      via: "import search_terminology for autocomplete"
      pattern: "from protocol_processor\\.tools\\.tooluniverse_client import search_terminology"
    - from: "services/api-service/src/api_service/umls_search.py"
      to: "services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py"
      via: "import search_terminology replacing UmlsClient"
      pattern: "from protocol_processor\\.tools\\.tooluniverse_client import search_terminology"
---

<objective>
Delete all three legacy services (grounding-service, extraction-service, umls-mcp-server), create the ToolUniverse client wrapper, rewrite TerminologyRouter and API search endpoints to use ToolUniverse, clean up all workspace references, and rewrite broken tests.

Purpose: Eliminate legacy v1 code that is broken (0% CUI rate due to missing `concept_search` method on UmlsClient) and replace it with a working ToolUniverse SDK integration. This is the single-pass "delete + integrate" plan per user decision.

Output: Clean codebase with zero legacy imports, working ToolUniverse integration in protocol-processor-service, and API endpoints backed by ToolUniverse.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-legacy-cleanup-tooluniverse-grounding/40-RESEARCH.md
@services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
@services/protocol-processor-service/src/protocol_processor/config/routing.yaml
@services/api-service/src/api_service/umls_search.py
@services/api-service/src/api_service/terminology_search.py
@services/api-service/src/api_service/main.py
@pyproject.toml
@infra/docker-compose.yml
@services/api-service/pyproject.toml
@services/protocol-processor-service/pyproject.toml
@services/api-service/tests/test_schemas.py
@services/api-service/tests/test_umls_clients.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete legacy services and clean all workspace references</name>
  <files>
    services/grounding-service/ (DELETE entire directory)
    services/extraction-service/ (DELETE entire directory)
    services/umls-mcp-server/ (DELETE entire directory)
    pyproject.toml
    infra/docker-compose.yml
    services/api-service/pyproject.toml
    services/protocol-processor-service/pyproject.toml
  </files>
  <action>
    **Step 1: Delete legacy service directories**
    ```bash
    rm -rf services/grounding-service services/extraction-service services/umls-mcp-server
    ```

    **Step 2: Clean root pyproject.toml**
    Remove these entries from `[tool.uv.workspace] members`:
    - `"services/extraction-service"`
    - `"services/grounding-service"`
    - `"services/umls-mcp-server"`

    Remove these entries from `[tool.pytest.ini_options] pythonpath`:
    - `"services/extraction-service/src"`
    - `"services/grounding-service/src"`
    - `"services/umls-mcp-server/src"`

    Remove these entries from `[tool.coverage.run] source`:
    - `"services/extraction-service/src"`
    - `"services/grounding-service/src"`
    - `"services/umls-mcp-server/src"`

    Check `[tool.mypy.overrides]` for any ignore entries referencing these services and remove them.

    **Step 3: Clean services/api-service/pyproject.toml**
    Remove `umls-mcp-server` from `[project] dependencies`.
    Remove `umls-mcp-server` from `[tool.uv.sources]`.
    Remove legacy service paths from `[tool.pytest.ini_options] pythonpath` (e.g., `"../../services/umls-mcp-server/src"`).

    **Step 4: Clean services/protocol-processor-service/pyproject.toml**
    Remove any references to `grounding-service`, `extraction-service`, or `umls-mcp-server` from dependencies, `[tool.uv.sources]`, `[tool.mypy] mypy_path`, and `[tool.pytest.ini_options] pythonpath`.
    ADD `tooluniverse` and `cachetools` as dependencies:
    ```
    "tooluniverse>=1.0.18",
    "cachetools>=5.0",
    ```

    **Step 5: Clean infra/docker-compose.yml**
    Remove the `extraction-service` and `grounding-service` service blocks entirely (they are under `profiles: [agents]`). Keep everything else.

    **Step 6: Regenerate lock file**
    ```bash
    cd /Users/noahdolevelixir/Code/medgemma-hackathon && uv sync
    ```
    This will regenerate `uv.lock` without the deleted workspace members. Commit the updated `uv.lock`.

    **IMPORTANT PITFALL:** Do NOT use `uv sync --frozen` — it will fail because the lock file still references deleted packages. Use plain `uv sync` to regenerate.
  </action>
  <verify>
    ```bash
    # Directories gone
    test ! -d services/grounding-service && test ! -d services/extraction-service && test ! -d services/umls-mcp-server && echo "PASS: dirs deleted"

    # No references in workspace config
    grep -r "grounding-service\|extraction-service\|umls-mcp-server" pyproject.toml services/api-service/pyproject.toml services/protocol-processor-service/pyproject.toml infra/docker-compose.yml && echo "FAIL: refs remain" || echo "PASS: refs cleaned"

    # uv sync succeeds
    uv sync && echo "PASS: uv sync ok"
    ```
  </verify>
  <done>
    Three legacy service directories deleted. All references removed from root pyproject.toml (workspace members, pythonpath, coverage, mypy), api-service pyproject.toml, protocol-processor-service pyproject.toml, and docker-compose.yml. `uv sync` succeeds and `uv.lock` is updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ToolUniverse client wrapper and rewrite TerminologyRouter + API endpoints + tests</name>
  <files>
    services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py (NEW)
    services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py
    services/protocol-processor-service/src/protocol_processor/config/routing.yaml
    services/api-service/src/api_service/umls_search.py
    services/api-service/src/api_service/terminology_search.py
    services/api-service/src/api_service/main.py
    services/api-service/tests/test_schemas.py
    services/api-service/tests/test_umls_clients.py
  </files>
  <action>
    **Part A: Create tooluniverse_client.py (NEW FILE)**

    Create `services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py` using the complete code example from 40-RESEARCH.md (Pattern 1 + the `search_terminology` function + `_call_tool` + `_parse_result`). Key details:
    - Module-level singleton via `@lru_cache(maxsize=1)` on `_get_tu()`
    - `_TOOL_CATEGORIES = ["umls", "icd", "loinc", "rxnorm", "hpo"]` for selective loading
    - `_SYSTEM_TOOL_MAP` mapping all 6 systems to their ToolUniverse tool names (verified in research):
      - umls -> umls_search_concepts
      - snomed -> snomed_search_concepts
      - icd10 -> ICD10_search_codes
      - loinc -> LOINC_search_tests
      - rxnorm -> RxNorm_get_drug_names
      - hpo -> HPO_search_terms
    - `TTLCache(maxsize=1000, ttl=300)` for autocomplete caching (5-min TTL)
    - Each system's response parsing handles its unique format (see Pattern 3 in research):
      - UMLS/SNOMED: `data.result.results[].{ui, name, rootSource}`
      - ICD10: `data.results[].{code, name}`
      - LOINC: `results[].{code/LOINC_NUM, LONG_COMMON_NAME}`
      - RxNorm: single dict `{rxcui, drug_name}` (NOT a list)
      - HPO: `data[].{id, name}`
    - Check for `"error"` key in raw result (UMLS_API_KEY missing case)
    - Returns `list[GroundingCandidate]` using existing schema from `protocol_processor.schemas.grounding`

    **Part B: Rewrite terminology_router.py**

    Rewrite `services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py`:
    1. Remove ALL imports of `httpx` (ToolUniverse handles HTTP internally)
    2. Remove `_RXNORM_APPROXIMATE_URL`, `_ICD10_SEARCH_URL`, `_LOINC_SEARCH_URL`, `_HPO_SEARCH_URL` constants
    3. Remove `_HTTP_TIMEOUT` constant
    4. Delete methods: `_query_umls`, `_query_snomed`, `_query_direct_api` (and any `_fetch_*` methods)
    5. Add single method `_query_tooluniverse(self, api_name: str, entity_text: str) -> list[GroundingCandidate]`:
       - Import `search_terminology` from `protocol_processor.tools.tooluniverse_client`
       - Call `search_terminology(api_name, entity_text, max_results=10)`
       - Wrap with tenacity retry decorator for `TransientAPIError` (keep existing retry config: `stop_after_attempt(3)`, `wait_random_exponential(multiplier=1, min=2, max=10)`)
    6. Update `route_entity()` to call `_query_tooluniverse()` for ALL api_names (replacing the old dispatch logic that checked `api_configs[api_name]["source"]`)
    7. Keep: YAML config loading, entity type routing logic, error accumulation, `get_apis_for_entity()`, diskcache, tenacity imports, logging
    8. Update docstring to reflect ToolUniverse backend

    **Part C: Update routing.yaml**

    Rewrite `services/protocol-processor-service/src/protocol_processor/config/routing.yaml`:
    - Keep `routing_rules` section as-is EXCEPT: change `Demographic` from `skip: true` to routing to `["umls", "snomed"]` (per user decision: demographics NOT blanket-skipped; age/gender attempt grounding)
    - Add a new entity type `Consent` with `skip: true` (consent/participation criteria should be skipped per user decision)
    - Rewrite `api_configs` section: ALL entries get `source: tooluniverse` and a `tool_name` field:
      ```yaml
      rxnorm:
        source: tooluniverse
        tool_name: RxNorm_get_drug_names
      icd10:
        source: tooluniverse
        tool_name: ICD10_search_codes
      loinc:
        source: tooluniverse
        tool_name: LOINC_search_tests
      hpo:
        source: tooluniverse
        tool_name: HPO_search_terms
      umls:
        source: tooluniverse
        tool_name: umls_search_concepts
      snomed:
        source: tooluniverse
        tool_name: snomed_search_concepts
      ```

    **Part D: Rewrite api-service search endpoints**

    Rewrite `services/api-service/src/api_service/umls_search.py`:
    - Remove import of `umls_mcp_server.umls_api` (deleted service)
    - Import `search_terminology` from `protocol_processor.tools.tooluniverse_client`
    - Keep the same endpoint URL (`/api/umls/search`) and response models
    - Rewrite the handler to call `search_terminology("umls", query, max_results=max_results)` and map `GroundingCandidate` results to `UmlsConceptResponse` (cui=code, name=preferred_term, etc.)

    Rewrite `services/api-service/src/api_service/terminology_search.py`:
    - Remove all `httpx` imports and NLM API URL constants
    - Import `search_terminology` from `protocol_processor.tools.tooluniverse_client`
    - Keep the same endpoint URL (`/api/terminology/{system}/search`) and response models
    - Rewrite the handler to call `search_terminology(system, query, max_results=max_results)` and map results to existing response models

    Check `services/api-service/src/api_service/main.py` — ensure router imports for `umls_search` and `terminology_search` still work (they should since the files still exist, just rewritten). No changes expected unless there are imports from deleted services.

    **Part E: Delete and rewrite broken tests**

    `services/api-service/tests/test_schemas.py`: Delete the ENTIRE file content and rewrite. The old file imports from `extraction_service.schemas.criteria` and `grounding_service.schemas.entities` which no longer exist. Write new tests that import from `protocol_processor.schemas.extraction` and `protocol_processor.schemas.grounding` and test basic Pydantic model validation (field presence, defaults, serialization).

    `services/api-service/tests/test_umls_clients.py`: Delete the ENTIRE file content and rewrite. Write new tests that:
    - Mock `protocol_processor.tools.tooluniverse_client.search_terminology`
    - Test the `/api/umls/search` endpoint returns correct response format
    - Test the `/api/terminology/{system}/search` endpoint for at least 2 systems
    - Use `unittest.mock.patch` to mock the ToolUniverse calls (see test pattern in research)

    **CRITICAL:** Do NOT add `tooluniverse` as a dependency to `services/api-service/pyproject.toml`. api-service imports the wrapper from protocol_processor which is already a workspace dependency.
  </action>
  <verify>
    ```bash
    # Check tooluniverse_client.py exists and has key functions
    grep -q "search_terminology" services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py && echo "PASS: client exists"
    grep -q "_get_tu" services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py && echo "PASS: singleton"

    # Check terminology_router.py has no legacy imports
    grep -q "httpx\|_query_umls\|_query_snomed\|_query_direct_api" services/protocol-processor-service/src/protocol_processor/tools/terminology_router.py && echo "FAIL: legacy code remains" || echo "PASS: router cleaned"

    # Check routing.yaml uses tooluniverse
    grep -q "tooluniverse" services/protocol-processor-service/src/protocol_processor/config/routing.yaml && echo "PASS: routing updated"

    # Check no imports from deleted services anywhere
    grep -r "from umls_mcp_server\|from grounding_service\|from extraction_service" services/ && echo "FAIL: legacy imports remain" || echo "PASS: zero legacy imports"

    # Run tests
    cd /Users/noahdolevelixir/Code/medgemma-hackathon && uv run pytest services/api-service/tests/ -x -q
    cd /Users/noahdolevelixir/Code/medgemma-hackathon && uv run pytest services/protocol-processor-service/tests/ -x -q
    ```
  </verify>
  <done>
    ToolUniverse client wrapper created with singleton pattern and TTLCache. TerminologyRouter rewritten to dispatch all 6 systems through ToolUniverse. routing.yaml updated with all tooluniverse sources and Demographics routed (not skipped). API search endpoints rewritten with ToolUniverse backend. Test files deleted and rewritten against new code. Zero imports from deleted services remain. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `test ! -d services/grounding-service && test ! -d services/extraction-service && test ! -d services/umls-mcp-server` -- all three deleted
2. `grep -r "from umls_mcp_server\|from grounding_service\|from extraction_service" services/` -- returns nothing (zero legacy imports)
3. `grep -r "grounding-service\|extraction-service\|umls-mcp-server" pyproject.toml infra/docker-compose.yml` -- returns nothing
4. `uv sync` succeeds without errors
5. `uv run pytest services/api-service/tests/ -x` passes
6. `uv run pytest services/protocol-processor-service/tests/ -x` passes
7. `grep "tooluniverse" services/protocol-processor-service/src/protocol_processor/config/routing.yaml` -- all 6 systems use tooluniverse
8. `grep "search_terminology" services/protocol-processor-service/src/protocol_processor/tools/tooluniverse_client.py` -- function exists
</verification>

<success_criteria>
- Three legacy service directories deleted (CLEAN-01)
- ToolUniverse client wrapper with singleton + TTLCache exists (CLEAN-02)
- TerminologyRouter dispatches through ToolUniverse for all 6 systems (CLEAN-02)
- API search endpoints use ToolUniverse backend (CLEAN-02)
- Zero imports from deleted services (CLEAN-03)
- All tests pass with no import errors
- `uv sync` and `uv.lock` updated cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/40-legacy-cleanup-tooluniverse-grounding/40-01-SUMMARY.md`
</output>

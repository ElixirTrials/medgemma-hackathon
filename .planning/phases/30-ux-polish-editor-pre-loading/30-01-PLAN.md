---
phase: 30-ux-polish-editor-pre-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/hitl-ui/src/screens/ReviewPage.tsx
  - apps/hitl-ui/src/components/CriterionCard.tsx
  - apps/hitl-ui/package.json
autonomous: true

must_haves:
  truths:
    - "Reviewed criteria have colored left border (green=approved, red/orange=rejected, yellow=pending) visually distinguishing them from pending criteria"
    - "Criteria are grouped into Inclusion/Exclusion sections with bold headers showing review progress count (e.g., 'Inclusion Criteria (8/12 reviewed)')"
    - "Uncategorized criteria appear in a 'To Be Sorted' panel at the top if any exist"
    - "Within each section pending criteria appear before reviewed criteria"
    - "Sticky search/filter bar above criteria sections with text search (debounced 300ms) and dropdowns for status, type, and confidence level"
    - "Filtering is client-side and instant on already-loaded data, showing/hiding cards without text highlighting"
  artifacts:
    - path: "apps/hitl-ui/src/screens/ReviewPage.tsx"
      provides: "Search/filter state, client-side filtering with useMemo, section grouping with headers, sticky filter bar"
    - path: "apps/hitl-ui/src/components/CriterionCard.tsx"
      provides: "Left border color based on review_status"
  key_links:
    - from: "apps/hitl-ui/src/screens/ReviewPage.tsx"
      to: "apps/hitl-ui/src/components/CriterionCard.tsx"
      via: "Passes criterion prop; CriterionCard reads review_status for border color"
      pattern: "criterion\\.review_status"
---

<objective>
Add review status visual distinction, criteria section sorting with headers, and a sticky search/filter bar to the Review page.

Purpose: Reviewers need to quickly identify which criteria are reviewed vs pending, navigate sections efficiently, and find specific criteria in large batches.
Output: Enhanced ReviewPage.tsx with filtering/sorting/grouping and CriterionCard.tsx with status border colors.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-ux-polish-editor-pre-loading/30-CONTEXT.md
@.planning/phases/30-ux-polish-editor-pre-loading/30-RESEARCH.md
@apps/hitl-ui/src/screens/ReviewPage.tsx
@apps/hitl-ui/src/components/CriterionCard.tsx
@apps/hitl-ui/src/hooks/useReviews.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review status border colors and use-debounce install</name>
  <files>apps/hitl-ui/src/components/CriterionCard.tsx, apps/hitl-ui/package.json</files>
  <action>
1. Install `use-debounce` package: `cd apps/hitl-ui && npm install use-debounce`

2. In CriterionCard.tsx, update the root div's className to add left border color based on review_status. Replace the existing border logic:

Current:
```
className={cn(
    'rounded-lg border bg-card p-4 shadow-sm',
    isLowConfidence && 'border-l-4 border-l-red-300'
)}
```

New (per user decision — green=approved, red/orange=rejected, yellow=pending, blue=modified):
```
className={cn(
    'rounded-lg border bg-card p-4 shadow-sm border-l-4',
    criterion.review_status === 'approved' && 'border-l-green-500',
    criterion.review_status === 'rejected' && 'border-l-red-500',
    criterion.review_status === 'modified' && 'border-l-blue-500',
    !criterion.review_status && 'border-l-yellow-400',
)}
```

Note: The low-confidence red border is superseded by the status-based border. The review status border takes precedence since it carries more actionable information. Low confidence is already shown via the ConfidenceBadge.
  </action>
  <verify>Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` to confirm no TypeScript errors. Visually confirm the border-l-4 classes are applied correctly in the className.</verify>
  <done>CriterionCard has colored left border based on review_status: green for approved, red for rejected, blue for modified, yellow for pending. use-debounce is installed.</done>
</task>

<task type="auto">
  <name>Task 2: Sticky search/filter bar and section sorting with headers</name>
  <files>apps/hitl-ui/src/screens/ReviewPage.tsx</files>
  <action>
Major refactor of ReviewPage.tsx Criteria tab content. This is the largest task in the phase.

1. **Add imports:**
   - `import { useState, useMemo } from 'react';` (useState already imported, add useMemo)
   - `import { useDebounce } from 'use-debounce';`
   - `import { Search } from 'lucide-react';` (for search icon)

2. **Add filter state variables** (inside ReviewPage component, near existing state):
   ```typescript
   const [searchText, setSearchText] = useState('');
   const [statusFilter, setStatusFilter] = useState<string>('all');
   const [typeFilter, setTypeFilter] = useState<string>('all');
   const [confidenceFilter, setConfidenceFilter] = useState<string>('all');
   const [debouncedSearch] = useDebounce(searchText, 300);
   ```

3. **Add client-side filtering with useMemo:**
   ```typescript
   const filteredCriteria = useMemo(() => {
     if (!criteria) return [];
     return criteria.filter(c => {
       // Text search (case-insensitive)
       if (debouncedSearch && !c.text.toLowerCase().includes(debouncedSearch.toLowerCase())) {
         return false;
       }
       // Status filter
       if (statusFilter !== 'all') {
         const isReviewed = c.review_status !== null;
         if (statusFilter === 'reviewed' && !isReviewed) return false;
         if (statusFilter === 'pending' && isReviewed) return false;
       }
       // Type filter
       if (typeFilter !== 'all' && c.criteria_type !== typeFilter) {
         return false;
       }
       // Confidence filter (reuse ConfidenceBadge thresholds: high>=0.85, medium>=0.7, low<0.7)
       if (confidenceFilter !== 'all') {
         if (confidenceFilter === 'high' && c.confidence < 0.85) return false;
         if (confidenceFilter === 'medium' && (c.confidence < 0.7 || c.confidence >= 0.85)) return false;
         if (confidenceFilter === 'low' && c.confidence >= 0.7) return false;
       }
       return true;
     });
   }, [criteria, debouncedSearch, statusFilter, typeFilter, confidenceFilter]);
   ```

4. **Add section grouping with useMemo:**
   ```typescript
   const { uncategorizedCriteria, inclusionCriteria, exclusionCriteria } = useMemo(() => {
     const uncategorized: Criterion[] = [];
     const inclusion: Criterion[] = [];
     const exclusion: Criterion[] = [];

     filteredCriteria.forEach(c => {
       if (!c.criteria_type || (c.criteria_type !== 'inclusion' && c.criteria_type !== 'exclusion')) {
         uncategorized.push(c);
       } else if (c.criteria_type === 'inclusion') {
         inclusion.push(c);
       } else {
         exclusion.push(c);
       }
     });

     // Sort each group: pending first, then reviewed
     const sortFn = (a: Criterion, b: Criterion) => {
       const aPending = a.review_status === null;
       const bPending = b.review_status === null;
       if (aPending && !bPending) return -1;
       if (!aPending && bPending) return 1;
       return 0;
     };
     uncategorized.sort(sortFn);
     inclusion.sort(sortFn);
     exclusion.sort(sortFn);

     return { uncategorizedCriteria: uncategorized, inclusionCriteria: inclusion, exclusionCriteria: exclusion };
   }, [filteredCriteria]);
   ```

   Add a helper function for counting reviewed in a list:
   ```typescript
   const countReviewed = (list: Criterion[]) => list.filter(c => c.review_status !== null).length;
   ```

5. **Replace the existing Criteria tab content** (inside `<Tabs.Content value="criteria">`). Remove the existing sort controls div and the criteria cards div. Replace with:

   a. **Sticky filter bar** (ABOVE the sections, INSIDE the scrollable content area but with `sticky top-0`):
   ```tsx
   <div className="sticky top-0 z-10 bg-card border-b px-4 py-3">
     <div className="flex items-center gap-3 flex-wrap">
       <div className="relative flex-1 min-w-[200px]">
         <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
         <input
           type="text"
           value={searchText}
           onChange={(e) => setSearchText(e.target.value)}
           placeholder="Search criteria..."
           className="w-full rounded-md border border-input bg-background pl-9 pr-3 py-2 text-sm"
         />
       </div>
       <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)}
         className="rounded-md border border-input bg-background px-3 py-2 text-sm">
         <option value="all">All Status</option>
         <option value="pending">Pending</option>
         <option value="reviewed">Reviewed</option>
       </select>
       <select value={typeFilter} onChange={(e) => setTypeFilter(e.target.value)}
         className="rounded-md border border-input bg-background px-3 py-2 text-sm">
         <option value="all">All Types</option>
         <option value="inclusion">Inclusion</option>
         <option value="exclusion">Exclusion</option>
       </select>
       <select value={confidenceFilter} onChange={(e) => setConfidenceFilter(e.target.value)}
         className="rounded-md border border-input bg-background px-3 py-2 text-sm">
         <option value="all">All Confidence</option>
         <option value="high">High (≥85%)</option>
         <option value="medium">Medium (70-84%)</option>
         <option value="low">Low (&lt;70%)</option>
       </select>
     </div>
   </div>
   ```

   b. **Section headers with progress counts and criteria cards:**
   ```tsx
   <div className="p-4 space-y-6">
     {/* To Be Sorted — appears at top if any uncategorized criteria exist */}
     {uncategorizedCriteria.length > 0 && (
       <section>
         <h2 className="text-lg font-bold mb-3 text-foreground">
           To Be Sorted ({countReviewed(uncategorizedCriteria)}/{uncategorizedCriteria.length} reviewed)
         </h2>
         <div className="space-y-4">
           {uncategorizedCriteria.map(c => (
             <CriterionCard key={c.id} criterion={c} onAction={handleAction}
               isSubmitting={reviewAction.isPending} onCriterionClick={handleCriterionClick}
               isActive={activeCriterion?.id === c.id} />
           ))}
         </div>
       </section>
     )}

     {/* Inclusion Criteria section */}
     {inclusionCriteria.length > 0 && (
       <section>
         <h2 className="text-lg font-bold mb-3 text-foreground">
           Inclusion Criteria ({countReviewed(inclusionCriteria)}/{inclusionCriteria.length} reviewed)
         </h2>
         <div className="space-y-4">
           {inclusionCriteria.map(c => (
             <CriterionCard key={c.id} criterion={c} onAction={handleAction}
               isSubmitting={reviewAction.isPending} onCriterionClick={handleCriterionClick}
               isActive={activeCriterion?.id === c.id} />
           ))}
         </div>
       </section>
     )}

     {/* Exclusion Criteria section */}
     {exclusionCriteria.length > 0 && (
       <section>
         <h2 className="text-lg font-bold mb-3 text-foreground">
           Exclusion Criteria ({countReviewed(exclusionCriteria)}/{exclusionCriteria.length} reviewed)
         </h2>
         <div className="space-y-4">
           {exclusionCriteria.map(c => (
             <CriterionCard key={c.id} criterion={c} onAction={handleAction}
               isSubmitting={reviewAction.isPending} onCriterionClick={handleCriterionClick}
               isActive={activeCriterion?.id === c.id} />
           ))}
         </div>
       </section>
     )}

     {/* Empty state when filters match nothing */}
     {filteredCriteria.length === 0 && criteria && criteria.length > 0 && (
       <div className="text-center py-8">
         <p className="text-muted-foreground">No criteria match your filters</p>
       </div>
     )}

     {/* Original empty state when no criteria at all */}
     {(!criteria || criteria.length === 0) && (
       <div className="text-center py-8">
         <p className="text-muted-foreground">No criteria found for this batch</p>
       </div>
     )}

     {/* Audit trail section (keep existing) */}
   </div>
   ```

   c. Keep the audit trail section as-is, moved inside the `<div className="p-4 space-y-6">` wrapper.

6. **Update progress bar counts** to use `filteredCriteria` when showing the overall progress (keep using original `criteria` array for the actual progress bar since progress should reflect total, not filtered).

7. **Remove the old sort controls** (the sortBy/sortOrder state and SORT_OPTIONS constant). The section grouping and filtering replaces server-side sorting. If you want to keep the sort state for the API call, that's fine, but remove the UI sort controls since they're replaced by the filter bar.

**IMPORTANT: The Tabs.Content for "criteria" needs restructuring.** Currently it has `className="p-4"`. Change it to `className=""` (no padding) since the filter bar needs full-width sticky behavior, and the content area below gets its own padding.

**Sticky positioning note:** The filter bar must be inside the `overflow-auto` container (the `<div className="h-full overflow-auto">` parent). The existing sticky header (back link + progress bar) already works in this container — add the filter bar below the Tabs.List but inside the tab content.
  </action>
  <verify>
1. Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` — zero TypeScript errors.
2. Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx biome check src/screens/ReviewPage.tsx` — zero lint errors.
3. Verify useMemo dependency arrays are complete (criteria, debouncedSearch, statusFilter, typeFilter, confidenceFilter for filtering; filteredCriteria for grouping).
4. Verify all criteria.map() uses `c.id` as key, never array index.
  </verify>
  <done>
ReviewPage has: (1) sticky search/filter bar with debounced text search and dropdowns for status, type, confidence; (2) criteria grouped into "To Be Sorted" / "Inclusion Criteria" / "Exclusion Criteria" sections with bold headers showing review progress count; (3) within each section, pending criteria sorted before reviewed; (4) client-side filtering is instant on loaded data. Old sort controls removed.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit` — zero errors
2. `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx biome check src/` — zero errors
3. Visual inspection: CriterionCard has colored left border per review_status
4. Visual inspection: ReviewPage groups criteria into sections with progress counts
5. Visual inspection: Filter bar sticks to top while scrolling
</verification>

<success_criteria>
- Criteria cards have review-status colored left borders (green/red/blue/yellow)
- Three section headers visible: "To Be Sorted" (conditional), "Inclusion Criteria", "Exclusion Criteria" with "(N/M reviewed)" counts
- Pending criteria appear before reviewed in each section
- Sticky filter bar with text search + 3 dropdown filters
- Client-side filtering works with 300ms debounced text search
</success_criteria>

<output>
After completion, create `.planning/phases/30-ux-polish-editor-pre-loading/30-01-SUMMARY.md`
</output>

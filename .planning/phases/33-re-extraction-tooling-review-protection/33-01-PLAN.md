---
phase: 33-re-extraction-tooling-review-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/shared/src/shared/models.py
  - services/api-service/alembic/versions/33_01_add_batch_is_archived.py
  - services/api-service/src/api_service/reviews.py
  - services/api-service/src/api_service/protocols.py
  - services/api-service/src/api_service/fuzzy_matching.py
  - services/extraction-service/src/extraction_service/nodes/extract.py
  - services/api-service/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "POST /protocols/{id}/re-extract archives old batches and triggers extraction pipeline"
    - "Re-extraction creates a new batch alongside archived old batches (not replacing)"
    - "Dashboard and review page only show non-archived batches"
    - "New batch criteria auto-inherit review decisions from archived batch criteria with >90% fuzzy text match"
    - "Extraction uses temperature=0 for determinism"
  artifacts:
    - path: "services/api-service/src/api_service/fuzzy_matching.py"
      provides: "Fuzzy matching utilities for review inheritance"
      contains: "find_matching_reviewed_criterion"
    - path: "services/api-service/alembic/versions/33_01_add_batch_is_archived.py"
      provides: "Alembic migration adding is_archived to CriteriaBatch"
      contains: "is_archived"
    - path: "libs/shared/src/shared/models.py"
      provides: "CriteriaBatch model with is_archived field"
      contains: "is_archived"
  key_links:
    - from: "services/api-service/src/api_service/protocols.py"
      to: "services/api-service/src/api_service/fuzzy_matching.py"
      via: "import for review inheritance on re-extraction"
      pattern: "find_matching_reviewed_criterion"
    - from: "services/api-service/src/api_service/reviews.py"
      to: "libs/shared/src/shared/models.py"
      via: "is_archived filter in batch queries"
      pattern: "is_archived.*False"
---

<objective>
Backend re-extraction endpoint with batch archiving, fuzzy review inheritance, and extraction determinism.

Purpose: Enable researchers to re-extract criteria on existing protocols without re-uploading the PDF. Old batches are archived (preserved but hidden from dashboard). New batch criteria auto-inherit review decisions from matching archived criteria using fuzzy text matching. Extraction determinism improved via temperature=0.

Output: RE-extraction API endpoint, batch archiving system, fuzzy matching module, determinism config.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-re-extraction-tooling-review-protection/33-CONTEXT.md
@.planning/phases/33-re-extraction-tooling-review-protection/33-RESEARCH.md

@libs/shared/src/shared/models.py
@services/api-service/src/api_service/protocols.py
@services/api-service/src/api_service/reviews.py
@services/extraction-service/src/extraction_service/nodes/extract.py
@services/api-service/alembic/versions/07_01_protocol_status_enum.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + model update + fuzzy matching module + RapidFuzz dependency</name>
  <files>
    libs/shared/src/shared/models.py
    services/api-service/alembic/versions/33_01_add_batch_is_archived.py
    services/api-service/src/api_service/fuzzy_matching.py
    services/api-service/pyproject.toml
  </files>
  <action>
    1. Add `is_archived` field to `CriteriaBatch` model in `libs/shared/src/shared/models.py`:
       - `is_archived: bool = Field(default=False, index=True)` — add after the `updated_at` field
       - This field controls dashboard/review visibility. Archived batches are preserved but hidden.

    2. Create Alembic migration `services/api-service/alembic/versions/33_01_add_batch_is_archived.py`:
       - Use the three-step pattern from RESEARCH.md to avoid NULL constraint issues on existing rows:
         - Step 1: Add nullable column with `server_default=sa.false()`
         - Step 2: Backfill existing rows: `UPDATE criteriabatch SET is_archived = false WHERE is_archived IS NULL`
         - Step 3: Alter column to non-nullable
       - Downgrade drops the column
       - Follow existing migration naming convention (see `07_01_protocol_status_enum.py` for pattern)

    3. Add `rapidfuzz` dependency to `services/api-service/pyproject.toml`:
       - Run `cd /Users/noahdolevelixir/Code/medgemma-hackathon/services/api-service && uv add rapidfuzz`

    4. Create `services/api-service/src/api_service/fuzzy_matching.py`:
       - Implement `find_matching_reviewed_criterion(new_text: str, new_criteria_type: str, old_criteria: list, threshold: float = 90.0) -> dict | None`
       - Use `rapidfuzz.fuzz.token_set_ratio` (NOT `fuzz.ratio` — too strict for word order variations in AI-generated text)
       - CRITICAL: Check criteria_type match (inclusion vs exclusion) before comparing text to prevent false positives per Pitfall 2 in RESEARCH.md (e.g., "Age >= 18 years" inclusion vs "Age < 18 years" exclusion would score 91.7% but mean opposite things)
       - Return dict with `criterion_id`, `review_status`, `reviewed_by`, `match_score` if match found, else None
       - Implement `inherit_reviews_for_batch(new_criteria: list, archived_criteria: list) -> list[dict]` that applies fuzzy matching across all criteria and returns list of inheritance results
       - Add logging for match scores (INFO level for matches, DEBUG for non-matches) for future threshold tuning
  </action>
  <verify>
    - `uv run --directory /Users/noahdolevelixir/Code/medgemma-hackathon/services/api-service alembic upgrade head` runs without error
    - `uv run --directory /Users/noahdolevelixir/Code/medgemma-hackathon/services/api-service python -c "from api_service.fuzzy_matching import find_matching_reviewed_criterion, inherit_reviews_for_batch; print('OK')"` succeeds
    - `uv run --directory /Users/noahdolevelixir/Code/medgemma-hackathon/services/api-service python -c "from rapidfuzz import fuzz; print(fuzz.token_set_ratio('Age >= 18 years', 'Patient must be 18 years of age or older'))"` returns >90
    - `uv run ruff check services/api-service/src/api_service/fuzzy_matching.py` passes
  </verify>
  <done>
    CriteriaBatch model has is_archived field, migration applies cleanly, RapidFuzz installed, fuzzy matching module correctly identifies matching criteria with >90% token_set_ratio while filtering by criteria_type to prevent false positives.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-extraction endpoint + batch archiving queries + temperature=0 config</name>
  <files>
    services/api-service/src/api_service/protocols.py
    services/api-service/src/api_service/reviews.py
    services/extraction-service/src/extraction_service/nodes/extract.py
  </files>
  <action>
    1. Add `POST /protocols/{protocol_id}/re-extract` endpoint in `protocols.py`:
       - Follow the existing `retry_protocol` pattern for endpoint structure and error handling
       - Validate protocol exists (404 if not)
       - Validate protocol is in a terminal state (`pending_review`, `complete`, `extraction_failed`, `grounding_failed`, `dead_letter`) — return 409 Conflict if in a processing state (extracting, grounding) to prevent race conditions per Pitfall 5
       - Archive all existing non-archived batches for this protocol: set `is_archived = True` on each
       - Collect all reviewed criteria from the batches being archived (for inheritance later)
       - Update protocol status to `"extracting"`
       - Trigger extraction via outbox event using `persist_with_outbox` with `DomainEventKind.PROTOCOL_UPLOADED` (reuses existing extraction pipeline — same as upload flow)
       - Return `{"status": "extracting", "protocol_id": protocol_id, "archived_batches": count}`
       - Per user decision: no user-facing model/temperature settings

    2. Add review inheritance hook in `protocols.py`:
       - After the extraction pipeline completes and creates the new batch (this happens asynchronously via outbox), the inheritance needs to run
       - Create a helper function `_apply_review_inheritance(db: Session, protocol_id: str)` that:
         a. Finds the newest non-archived batch for the protocol
         b. Finds all archived batches' reviewed criteria (status in approved/rejected/modified)
         c. Calls `inherit_reviews_for_batch` from fuzzy_matching module
         d. For each match: creates a Review record copying the old review decision, and updates the criterion's review status
         e. Logs summary: "Inherited N/M review decisions for protocol {id}"
       - Register this function to run in the queue node or as a post-extraction callback (check how extraction-service currently signals completion — likely via outbox event or status update)
       - ALTERNATIVE APPROACH: If hooking into the async pipeline is too complex, implement inheritance directly in the re-extract endpoint AFTER archiving but BEFORE triggering extraction. The inheritance would then run when the new batch is created by the extraction pipeline. To handle this, add a `_pending_inheritance` helper that the queue node can call after batch creation. The simplest approach: make the re-extract endpoint store the archived criteria IDs in the outbox payload so the pipeline can access them.

    3. Update `list_batches` in `reviews.py`:
       - Add `CriteriaBatch.is_archived == False` filter to the base query so archived batches never appear in dashboard or review page
       - This is CRITICAL per Pitfall 1 in RESEARCH.md — forgetting this filter means users see duplicate batches
       - Also check `get_batch_criteria` and any other batch query functions for the same filter need

    4. Set `temperature=0.0` in extraction config in `extract.py`:
       - In the `GenerateContentConfig` call, add `temperature=0.0` parameter for deterministic greedy decoding
       - Per user decision: configured in code, not user-facing
       - Note: temperature=0 is "mostly deterministic" per RESEARCH.md — 100% determinism not guaranteed due to hardware factors, but fuzzy matching absorbs minor variations
  </action>
  <verify>
    - `uv run ruff check services/api-service/src/api_service/protocols.py services/api-service/src/api_service/reviews.py` passes
    - `uv run mypy services/api-service/src/api_service/protocols.py` passes (or has only pre-existing errors)
    - Verify temperature=0 is present: `grep -n "temperature" services/extraction-service/src/extraction_service/nodes/extract.py` shows `temperature=0.0`
    - Verify is_archived filter: `grep -n "is_archived" services/api-service/src/api_service/reviews.py` shows filter in list_batches
    - `uv run ruff check services/extraction-service/src/extraction_service/nodes/extract.py` passes
  </verify>
  <done>
    POST /protocols/{id}/re-extract endpoint archives old batches, triggers extraction pipeline, and returns status. Batch list queries filter out archived batches. Extraction uses temperature=0. Review inheritance mechanism is in place to auto-apply old review decisions to matching new criteria via fuzzy matching.
  </done>
</task>

</tasks>

<verification>
- Alembic migration applies and rolls back cleanly
- CriteriaBatch model has is_archived field with default=False
- POST /protocols/{id}/re-extract returns 200 for terminal-state protocols
- POST /protocols/{id}/re-extract returns 409 for in-progress protocols
- list_batches excludes archived batches
- Fuzzy matching correctly identifies >90% text similarity while respecting criteria_type
- Extraction GenerateContentConfig includes temperature=0.0
- `uv run ruff check .` passes for modified files
</verification>

<success_criteria>
Re-extraction endpoint exists and archives old batches before triggering new extraction. Dashboard/review queries exclude archived batches. Fuzzy matching module implements token_set_ratio with criteria_type guard. Extraction determinism improved with temperature=0. All modified files pass linting.
</success_criteria>

<output>
After completion, create `.planning/phases/33-re-extraction-tooling-review-protection/33-01-SUMMARY.md`
</output>

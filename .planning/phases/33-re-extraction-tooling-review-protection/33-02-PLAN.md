---
phase: 33-re-extraction-tooling-review-protection
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - apps/hitl-ui/src/screens/ProtocolDetail.tsx
  - apps/hitl-ui/src/hooks/useProtocols.ts
autonomous: true

must_haves:
  truths:
    - "Researcher can click 'Re-extract Criteria' button on protocol detail page"
    - "Confirmation modal warns that old batches will be saved but not available in the dashboard"
    - "Re-extraction button is disabled for protocols in processing states (extracting, grounding)"
    - "User sees processing spinner with status message during re-extraction"
    - "User sees link to review page when new batch is ready"
  artifacts:
    - path: "apps/hitl-ui/src/hooks/useProtocols.ts"
      provides: "useReExtractProtocol mutation hook"
      contains: "useReExtractProtocol"
    - path: "apps/hitl-ui/src/screens/ProtocolDetail.tsx"
      provides: "Re-extraction button with confirmation modal and processing states"
      contains: "Re-extract"
  key_links:
    - from: "apps/hitl-ui/src/screens/ProtocolDetail.tsx"
      to: "apps/hitl-ui/src/hooks/useProtocols.ts"
      via: "useReExtractProtocol hook for mutation"
      pattern: "useReExtractProtocol"
    - from: "apps/hitl-ui/src/hooks/useProtocols.ts"
      to: "/protocols/{id}/re-extract"
      via: "POST API call"
      pattern: "re-extract"
---

<objective>
Frontend re-extraction UI with confirmation modal, processing states, and review link.

Purpose: Allow researchers to trigger re-extraction directly from the protocol detail page with clear confirmation messaging about batch archiving and review preservation. Show processing status and link to review page when new batch is ready.

Output: Re-extraction button, confirmation dialog, processing spinner, review link.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-re-extraction-tooling-review-protection/33-CONTEXT.md
@.planning/phases/33-re-extraction-tooling-review-protection/33-RESEARCH.md
@.planning/phases/33-re-extraction-tooling-review-protection/33-01-SUMMARY.md

@apps/hitl-ui/src/screens/ProtocolDetail.tsx
@apps/hitl-ui/src/hooks/useProtocols.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: useReExtractProtocol mutation hook</name>
  <files>
    apps/hitl-ui/src/hooks/useProtocols.ts
  </files>
  <action>
    Add `useReExtractProtocol` mutation hook to `useProtocols.ts`:
    - Follow existing mutation patterns in the file (e.g., useRetryProtocol if it exists, or other useMutation patterns)
    - `mutationFn`: POST to `/protocols/${protocolId}/re-extract` using the existing `fetchApi` utility
    - `onSuccess`: Invalidate `['protocols']` and `['review-batches']` query keys to refresh lists
    - Return type: `{ status: string; protocol_id: string; archived_batches: number }`
    - Export the hook for use in ProtocolDetail.tsx
  </action>
  <verify>
    - TypeScript compiles: `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit 2>&1 | grep -i "useProtocols" || echo "No TS errors in useProtocols"`
    - Hook is exported: `grep "useReExtractProtocol" apps/hitl-ui/src/hooks/useProtocols.ts`
  </verify>
  <done>
    useReExtractProtocol hook exported from useProtocols.ts, calls POST /protocols/{id}/re-extract, invalidates relevant query caches on success.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-extraction button, confirmation modal, and processing states in ProtocolDetail</name>
  <files>
    apps/hitl-ui/src/screens/ProtocolDetail.tsx
  </files>
  <action>
    Add re-extraction UI to `ProtocolDetail.tsx`:

    1. **Re-extraction button** (per user decision: on protocol detail page, NOT review page):
       - Add "Re-extract Criteria" button with a RefreshCw icon (from lucide-react, already in deps)
       - Button variant: "outline" to differentiate from primary actions
       - DISABLE the button when protocol is in a processing state: only enable when status is one of `pending_review`, `complete`, `extraction_failed`, `grounding_failed`, `dead_letter` (per Pitfall 5 in RESEARCH.md)
       - Also disable when `reExtractMutation.isPending` to prevent double-clicks

    2. **Confirmation modal** using Radix UI AlertDialog (already in dependencies):
       - Use existing AlertDialog components from the UI library (check `apps/hitl-ui/src/components/ui/` for existing AlertDialog or import from @radix-ui/react-alert-dialog)
       - Title: "Re-extract criteria?"
       - Description: "Old batches will be saved but not available in the dashboard. Existing reviews will be preserved and automatically applied to matching criteria." (per user decision on confirmation text)
       - Cancel button and "Re-extract" action button
       - On confirm: call `reExtractMutation.mutate(protocolId)`

    3. **Processing state display** (per user decision: spinner with link when ready):
       - When protocol.status is `extracting` after re-extraction was triggered: show a blue info banner with Loader2 spinning icon, text "Re-extraction in progress", and "This typically takes 2-5 minutes."
       - When protocol returns to `pending_review` after re-extraction: show a link to the review page for the new batch — "Review New Criteria (N)" button
       - Use existing protocol status polling (the useProtocol hook should already refetch periodically — verify and add refetchInterval if needed)
       - Per user decision: user stays on protocol detail page after triggering

    4. **Error handling**:
       - Show toast or inline error if re-extraction fails (409 for in-progress, 404 for missing protocol)
       - Use existing error display patterns from the codebase
  </action>
  <verify>
    - TypeScript compiles: `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx tsc --noEmit 2>&1 | tail -5`
    - Re-extract button present: `grep "Re-extract" apps/hitl-ui/src/screens/ProtocolDetail.tsx`
    - AlertDialog used: `grep -i "alertdialog\|AlertDialog" apps/hitl-ui/src/screens/ProtocolDetail.tsx`
    - Processing state handled: `grep "extracting\|Loader2\|animate-spin" apps/hitl-ui/src/screens/ProtocolDetail.tsx`
    - Dev build succeeds: `cd /Users/noahdolevelixir/Code/medgemma-hackathon/apps/hitl-ui && npx vite build 2>&1 | tail -3`
  </verify>
  <done>
    ProtocolDetail page shows "Re-extract Criteria" button (disabled for in-progress protocols), confirmation modal with archiving warning, processing spinner during extraction, and link to review page when new batch is ready. TypeScript compiles and Vite build succeeds.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles with no new errors
- Vite build succeeds
- Re-extraction button rendered on ProtocolDetail page
- Confirmation modal shows correct warning text per user decision
- Button disabled for processing-state protocols
- Processing spinner shown during extraction
- Review link shown when batch ready
</verification>

<success_criteria>
Researcher can click "Re-extract Criteria" on protocol detail page, sees confirmation modal warning about batch archiving and review inheritance, and the re-extraction is triggered. During processing, a spinner is shown. When complete, a link to review the new batch appears. Button is disabled for protocols already being processed.
</success_criteria>

<output>
After completion, create `.planning/phases/33-re-extraction-tooling-review-protection/33-02-SUMMARY.md`
</output>

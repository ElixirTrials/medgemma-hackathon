---
phase: 05-entity-grounding-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/umls-mcp-server/pyproject.toml
  - services/umls-mcp-server/src/umls_mcp_server/__init__.py
  - services/umls-mcp-server/src/umls_mcp_server/server.py
  - services/umls-mcp-server/src/umls_mcp_server/umls_api.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "UMLS MCP server exposes concept_search, concept_linking, and semantic_type_prediction tools via FastMCP"
    - "concept_linking implements tiered grounding: exact match (0.95) -> semantic similarity (0.75) -> expert review (0.0)"
    - "Mock mode returns canned responses when UMLS_API_KEY is not set, enabling development without credentials"
    - "Server runs via stdio transport with `python -m umls_mcp_server.server`"
  artifacts:
    - path: "services/umls-mcp-server/src/umls_mcp_server/server.py"
      provides: "FastMCP server with 3 tools: concept_search, concept_linking, semantic_type_prediction"
      contains: "FastMCP"
    - path: "services/umls-mcp-server/src/umls_mcp_server/umls_api.py"
      provides: "UMLS REST API client with search, CUI lookup, and SNOMED crosswalk"
      contains: "UMLS_BASE_URL"
    - path: "services/umls-mcp-server/pyproject.toml"
      provides: "Package definition for umls-mcp-server with fastmcp and httpx deps"
      contains: "fastmcp"
  key_links:
    - from: "services/umls-mcp-server/src/umls_mcp_server/server.py"
      to: "services/umls-mcp-server/src/umls_mcp_server/umls_api.py"
      via: "import and async function calls"
      pattern: "from.*umls_api.*import"
---

<objective>
Build a lightweight UMLS MCP server as a new service, exposing concept search, concept linking, and semantic type prediction tools via FastMCP. The server uses the UMLS REST API (`uts-ws.nlm.nih.gov/rest`) as its backend and includes a mock mode for development without credentials.

Purpose: Agent-b needs a tool-based interface to UMLS for grounding medical entities to CUI and SNOMED-CT codes. The MCP server provides this abstraction, callable via langchain-mcp-adapters from LangGraph nodes.
Output: A new `services/umls-mcp-server` package with 3 MCP tools, UMLS REST API client, and mock fallback.
</objective>

<execution_context>
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/workflows/execute-plan.md
@/Users/noahdolevelixir/.claude-elixirtrials/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-entity-grounding-workflow/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: UMLS REST API client and mock fallback</name>
  <files>
    services/umls-mcp-server/pyproject.toml
    services/umls-mcp-server/src/umls_mcp_server/__init__.py
    services/umls-mcp-server/src/umls_mcp_server/umls_api.py
  </files>
  <action>
Create the `services/umls-mcp-server` package structure:

1. **pyproject.toml**: New package with:
   - name: `umls-mcp-server`
   - dependencies: `fastmcp`, `httpx`
   - hatch build target: `packages = ["src/umls_mcp_server"]`
   - Follow the same pyproject.toml structure as agent-b-service

2. **__init__.py**: Empty or minimal docstring.

3. **umls_api.py**: Async UMLS REST API client class `UMLSClient` with:
   - Constructor takes `api_key: str` (from env var `UMLS_API_KEY`)
   - `UMLS_BASE_URL = "https://uts-ws.nlm.nih.gov/rest"`
   - `async def search(self, term: str, sabs: str = "SNOMEDCT_US", search_type: str = "exact", max_results: int = 5) -> list[dict]`: Search UMLS concepts. Calls `GET /search/current` with params `string`, `apiKey`, `sabs`, `searchType`, `returnIdType=concept`, `pageSize`. Returns list of `{"cui": str, "name": str, "source": str}`.
   - `async def get_concept(self, cui: str) -> dict | None`: Validate CUI exists. Calls `GET /content/current/CUI/{cui}`. Returns concept dict or None.
   - `async def get_snomed_code(self, cui: str) -> str | None`: Get SNOMED-CT code for CUI. Calls `GET /search/current` with `string=cui`, `sabs=SNOMEDCT_US`, `returnIdType=code`. Returns SNOMED code string or None if no mapping.
   - All methods use `httpx.AsyncClient` with timeout of 30 seconds.
   - All methods have try/except with logging on failure, returning empty/None.

4. **Mock mode**: Create a `MockUMLSClient` class with the same interface that returns canned responses:
   - `search()` returns a single result: `[{"cui": "C0011849", "name": "Diabetes Mellitus", "source": "SNOMEDCT_US"}]`
   - `get_concept()` returns `{"cui": cui, "name": "Mock Concept"}`
   - `get_snomed_code()` returns `"73211009"` (diabetes SNOMED code)
   - Factory function `get_umls_client() -> UMLSClient | MockUMLSClient` that returns MockUMLSClient when `UMLS_API_KEY` is empty/unset.

5. **Root pyproject.toml**: Add `fastmcp` to root dependencies via `uv add fastmcp`. Add `langchain-mcp-adapters` too (needed in 05-03 but install now to avoid blocking). Add `services/umls-mcp-server` to `[tool.uv.workspace] members`. Add `langchain_mcp_adapters` and `langchain_mcp_adapters.*` to the mypy overrides ignore list.
  </action>
  <verify>
Run `uv run python -c "from umls_mcp_server.umls_api import UMLSClient, MockUMLSClient, get_umls_client; print('OK')"` to confirm imports work.
Run `uv run ruff check services/umls-mcp-server/` to verify no lint errors.
  </verify>
  <done>UMLS REST API client and mock fallback importable from umls_mcp_server.umls_api. Factory function returns MockUMLSClient when no API key is set.</done>
</task>

<task type="auto">
  <name>Task 2: FastMCP server with 3 UMLS tools</name>
  <files>
    services/umls-mcp-server/src/umls_mcp_server/server.py
  </files>
  <action>
Create `server.py` with a FastMCP server exposing 3 tools:

1. **Server setup**: `mcp = FastMCP("UMLS Grounding Server")`. Import and use `get_umls_client()` factory.

2. **Tool: concept_search**:
   - Signature: `async def concept_search(term: str, sabs: str = "SNOMEDCT_US", max_results: int = 5) -> list[dict]`
   - Docstring: "Search UMLS for concepts matching a medical term."
   - Implementation: Call `client.search(term, sabs=sabs, search_type="exact", max_results=max_results)`.

3. **Tool: concept_linking**:
   - Signature: `async def concept_linking(term: str, context: str = "", sabs: str = "SNOMEDCT_US") -> dict`
   - Docstring: "Link a medical term to its best-matching UMLS concept with tiered grounding."
   - Implementation (tiered):
     - **Tier 1 (exact match)**: Call `client.search(term, sabs=sabs, search_type="exact", max_results=1)`. If result, return `{**result[0], "confidence": 0.95, "method": "exact_match"}`.
     - **Tier 2 (semantic similarity)**: Call `client.search(term, sabs=sabs, search_type="words", max_results=5)`. If results, return `{**results[0], "confidence": 0.75, "method": "semantic_similarity"}`.
     - **Tier 3 (expert review)**: Return `{"cui": None, "name": None, "source": None, "confidence": 0.0, "method": "expert_review", "nearest_term": term}`.

4. **Tool: semantic_type_prediction**:
   - Signature: `async def semantic_type_prediction(term: str, entity_type: str) -> list[str]`
   - Docstring: "Predict UMLS semantic types for a medical entity based on its type."
   - Implementation: Static mapping dict (from research -- Condition -> T047/T048/T191, Medication -> T121/T200, Procedure -> T061/T060, Lab_Value -> T059/T034, Demographic -> T032, Biomarker -> T116/T123).

5. **Entry point**: `if __name__ == "__main__": mcp.run(transport="stdio")`

All tools decorated with `@mcp.tool()`. Each tool instantiates the client via `get_umls_client()` at call time (not module level) so mock/real is determined per-request based on env.
  </action>
  <verify>
Run `uv run python -c "from umls_mcp_server.server import mcp; print(mcp.name)"` to verify server loads.
Run `uv run ruff check services/umls-mcp-server/src/umls_mcp_server/server.py` to verify no lint errors.
Run `uv run mypy services/umls-mcp-server/src/umls_mcp_server/server.py --ignore-missing-imports` to verify type safety.
  </verify>
  <done>FastMCP server with 3 tools (concept_search, concept_linking, semantic_type_prediction) is importable and runs via stdio transport. Tiered grounding logic: exact match (0.95) -> semantic similarity (0.75) -> expert review (0.0).</done>
</task>

</tasks>

<verification>
- `uv run python -c "from umls_mcp_server.server import mcp; print(type(mcp))"` returns FastMCP type
- `uv run python -c "from umls_mcp_server.umls_api import get_umls_client; c = get_umls_client(); print(type(c).__name__)"` returns MockUMLSClient (no API key)
- `uv run ruff check services/umls-mcp-server/` passes clean
- `uv run pytest` passes with no regressions
</verification>

<success_criteria>
- UMLS MCP server package exists at services/umls-mcp-server with 3 tools
- concept_linking implements exact match -> semantic similarity -> expert review tiered strategy
- Mock mode works without UMLS_API_KEY for local development
- New dependencies (fastmcp, langchain-mcp-adapters) installed in workspace
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-entity-grounding-workflow/05-01-SUMMARY.md`
</output>

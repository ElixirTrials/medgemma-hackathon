# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'services/**'
              - 'libs/**'
              - 'pyproject.toml'
              - 'mkdocs.yml'
            frontend:
              - 'apps/hitl-ui/**'
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
              - 'services/**/docs/**'
              - 'services/**/mkdocs.yml'
              - 'libs/**/docs/**'
              - 'libs/**/mkdocs.yml'
              - 'apps/**/docs/**'
              - 'apps/**/mkdocs.yml'

  lint-and-type-check:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: github.event_name == 'push' || needs.paths-filter.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Install dependencies
        run: uv sync --all-extras
      - name: Lint with ruff
        run: uv run ruff check .
      - name: Format check
        run: uv run ruff format --check .
      - name: Type check
        run: uv run mypy libs/shared/src services/api-service/src libs/inference/src services/extraction-service/src services/grounding-service/src libs/data-pipeline/src libs/evaluation/src libs/events-py/src libs/model-training/src

  test:
    runs-on: ubuntu-latest
    needs: [paths-filter, lint-and-type-check]
    if: github.event_name == 'push' || needs.paths-filter.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Install dependencies
        run: uv sync --all-extras
      - name: Run tests
        run: uv run pytest --cov --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml

  frontend:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: github.event_name == 'push' || needs.paths-filter.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: apps/hitl-ui
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/hitl-ui/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run test -- --coverage
      - run: npm run build

  docs:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: github.event_name == 'push' || needs.paths-filter.outputs.docs == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Install dependencies
        run: uv sync --all-extras
      - name: Build docs in strict mode
        run: uv run mkdocs build --strict

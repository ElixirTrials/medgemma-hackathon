Implement the following plan:

# Plan: Dual-mode MLflow (Docker for prod, local for dev+Assistant)

## Context

MLflow was moved out of Docker to enable the MLflow Assistant beta (which requires a local server process to connect to Claude Code). However, for production deployments we need MLflow running in Docker alongside the rest of the stack. The Makefile also has stale references to a `mlflow` Docker service that no longer exists.

**Goal:** Support both modes via Docker Compose profiles — MLflow runs in Docker by default (prod), but can be excluded when running locally for Claude Code Assistant access.

## Approach: Docker Compose Profiles

Use the built-in `profiles` feature so `mlflow` is included in the default stack but can be swapped for a local instance in dev.

## Changes

### 1. `infra/docker-compose.yml` — Restore MLflow service, no profile (always starts)

- **Restore** the `mlflow` service (image `ghcr.io/mlflow/mlflow:v3.9.0`) and `mlflow_data` volume
- **Keep** the `host.docker.internal` tracking URI for the API but make it conditional:
  - Default: `http://mlflow:5000` (Docker-to-Docker networking, for prod)
  - Override with `MLFLOW_TRACKING_URI` env var from `.env` when running locally
- **API service** `depends_on` includes `mlflow: condition: service_started` again

The API environment becomes:
```yaml
- MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-http://mlflow:5000}
```

This way:
- **Prod (docker-compose up):** No `MLFLOW_TRACKING_URI` in shell → defaults to `http://mlflow:5000` (Docker internal)
- **Dev (local):** `.env` has `MLFLOW_TRACKING_URI=http://localhost:5001` → API uses local MLflow

### 2. `infra/docker-compose.dev.yml` — Dev override that disables Docker MLflow

Create a dev override file that:
- Removes the `mlflow` service (sets scale to 0 or overrides with a no-op)
- Changes the API's `MLFLOW_TRACKING_URI` to `http://host.docker.internal:5001`
- Removes the `depends_on` for mlflow

Actually simpler: use a **profile** on the mlflow service. Tag it with `profiles: [prod]`. Then:
- `docker compose up` (no profile) → MLflow does NOT start (dev mode, run it locally)
- `docker compose --profile prod up` → MLflow starts in Docker

Wait — the more intuitive default is prod (MLflow in Docker). So instead:
- Tag mlflow with NO profile (always starts by default)
- Dev users run: `docker compose up --scale mlflow=0` or use the override file

**Simplest approach:** Docker Compose override file.

```
# Dev: docker compose -f infra/docker-compose.yml -f infra/docker-compose.dev.yml up
# Prod: docker compose -f infra/docker-compose.yml up
```

### 3. `infra/docker-compose.dev.yml` — New file

```yaml
# Dev override: run MLflow locally for Claude Code Assistant support.
# Usage: docker compose -f infra/docker-compose.yml -f infra/docker-compose.dev.yml up
services:
  mlflow:
    # Replaces the MLflow Docker service with a lightweight no-op.
    # Run MLflow on your host: uv run mlflow server --port 5001
    image: busybox
    command: ["true"]
    restart: "no"

  api:
    depends_on:
      db:
        condition: service_healthy
    environment:
      - MLFLOW_TRACKING_URI=http://host.docker.internal:${MLFLOW_PORT:-5001}
```

### 4. `Makefile` — Fix stale references, add dev/prod targets

- `make run-dev`: Start DB only via docker-compose, start MLflow locally (`uv run mlflow server`), then API + UI
- `make run-infra`: Start DB + MLflow via docker-compose (prod mode)
- Add `make run-mlflow`: Start MLflow locally for dev (`uv run mlflow server --port 5001`)
- Help text updated

Key Makefile changes:
```makefile
run-dev:
    # Start DB only (MLflow runs locally for Assistant)
    docker compose -f infra/docker-compose.yml -f infra/docker-compose.dev.yml up -d db
    # Start MLflow locally
    uv run mlflow server --host 0.0.0.0 --port 5001 &
    # Wait for DB, start API + UI...

run-infra:
    # Prod: start DB + MLflow in Docker
    docker compose -f infra/docker-compose.yml up -d db mlflow
```

### 5. `.env` — No changes needed

`MLFLOW_TRACKING_URI=http://localhost:5001` is already set for local dev. In docker-compose.yml, the API service overrides this with the Docker-internal URI.

## Files to modify

| File | Action |
|------|--------|
| `infra/docker-compose.yml` | Restore `mlflow` service + `mlflow_data` volume, fix API `MLFLOW_TRACKING_URI` |
| `infra/docker-compose.dev.yml` | **New** — dev override that disables Docker MLflow |
| `Makefile` | Fix `run-dev` and `run-infra` targets |
| `infra/README.md` | Update with dev vs prod instructions |

## Verification

1. **Prod mode:** `docker compose -f infra/docker-compose.yml up` → MLflow UI at `localhost:5001`, API traces appear
2. **Dev mode:** `make run-dev` → MLflow runs locally at `localhost:5001`, Assistant panel available, API traces still appear
3. **Health check:** `curl http://localhost:5001/health` returns OK in both modes
4. **Existing tests:** `uv run pytest services/api-service/tests libs/events-py/tests -q` still pass


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/noahdolevelixir/.REDACTED.jsonl
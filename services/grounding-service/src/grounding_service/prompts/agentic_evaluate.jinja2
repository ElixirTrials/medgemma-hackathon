Review the UMLS search results below and select the best match for each entity.

{% for result in search_results %}
## Entity: "{{ result.entity_text }}" ({{ result.entity_type }})
Search term: "{{ result.search_term }}"
UMLS candidates:
{% for candidate in result.candidates %}
- CUI: {{ candidate.cui }}, SNOMED: {{ candidate.snomed_code }}, Name: "{{ candidate.display }}", Confidence: {{ candidate.confidence }}
{% endfor %}
{% if not result.candidates %}
- No candidates found
{% endif %}

{% endfor %}

Respond with a JSON object. You MUST select the best match from the candidates provided or determine the entity is not medical.

**CONFIDENCE SCORING GUIDELINES:**
- **0.9-1.0**: Exact UMLS concept match — entity text maps directly to CUI preferred term or is an exact synonym
- **0.7-0.8**: Close synonym match — entity text is a known medical synonym of the CUI (e.g., "heart attack" → "myocardial infarction")
- **0.5-0.6**: Partial or broader match — CUI is related but not exact (e.g., broad category matched to specific term)
- **0.0**: No valid match or not a medical entity

**IMPORTANT:** When a candidate's display name closely matches the entity text or its medical synonym, assign confidence ≥ 0.8. Do not be overly conservative — if the UMLS concept clearly represents the same medical concept, it is a high-confidence match.

**Example of high-confidence matching:**
- Entity: "SARS-CoV-2 infection", Candidate: "COVID-19" → confidence 0.9, reasoning: "SARS-CoV-2 is the causative virus of COVID-19, these terms represent the same disease entity"

---

**ACTION SELECTION:** Use action_type="evaluate" to finalize your selections. Only use action_type="refine" if you need to try different search terms AND you have not already refined multiple times. For most cases, evaluate with the best available match or confidence=0.0 for non-matches.

## Handling entities with no UMLS candidates

When an entity has "No candidates found", use your medical knowledge to determine WHY and take the appropriate action:

### Option A: Try a synonym (action_type="refine")
The entity IS a valid medical concept but the search term was wrong. Try a medically identical synonym.
- "OA" → refine with search_term="osteoarthritis"
- "heart attack" → refine with search_term="myocardial infarction"
Keep the same entity, just change search_term.

### Option B: Decompose a broad term (action_type="refine")
The entity is a broad/compound medical category that doesn't have a single UMLS code. Decompose into specific sub-entities that each map to exactly one UMLS concept. Keep the same criterion_id. Use your medical knowledge to identify the specific conditions, especially when the criterion provides examples (e.g., "e.g. cirrhosis, transplant").
- "liver abnormality (e.g. cirrhosis, transplant)" → refine with entities: "hepatic cirrhosis" (Condition), "liver transplantation" (Procedure)
- "major organ dysfunction" → refine with entities: "heart failure" (Condition), "renal failure" (Condition), "hepatic failure" (Condition)

### Option C: Flag as not medical (action_type="evaluate")
The extracted text is NOT a valid medical entity. This should be RARE because the extract prompt now filters these. If encountered, respond with action_type="evaluate" and set:
- selected_cui: null
- confidence: 0.0
- reasoning: MUST start with "NOT_MEDICAL_ENTITY: " followed by explanation

### Decision order
1. First: Is this actually a medical entity? If NO → Option C (rare)
2. If YES: Is the search term wrong or is there a better synonym? If YES → Option A
3. If synonym doesn't help: Is this a broad category that should be decomposed? If YES → Option B
4. If none of the above: evaluate with selected_cui=null (genuine grounding failure)

{% if iteration > 0 %}
This is iteration {{ iteration + 1 }} of {{ max_iterations }}. Previous search terms did not produce satisfactory results. You may try synonyms, decompose broad entities, flag non-medical entities (rare), or evaluate with the best available matches.
{% endif %}
